# RichmanManage ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ - æœ€çµ‚ä¿®æ­£æŒ‡ç¤ºæ›¸
## ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ªã¸ã®åˆ°é”ã‚¬ã‚¤ãƒ‰

**ä½œæˆæ—¥**: 2025-01-04  
**å¯¾è±¡**: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ #86 æŠœæœ¬çš„ä¿®æ­£æŒ‡ç¤ºæ›¸å®Ÿè£…ç‰ˆ  
**ç¾åœ¨è©•ä¾¡**: 6.8/10 (å®Ÿç”¨ãƒ¬ãƒ™ãƒ«)  
**ç›®æ¨™è©•ä¾¡**: 9.0/10 (ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ª)  
**ä½œæˆè€…**: Manus AI

---

## ğŸ“‹ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

RichmanManageãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®æŠœæœ¬çš„ä¿®æ­£å®Ÿè£…ç‰ˆã«ã¤ã„ã¦ã€è¶…ä¸€æµãƒ†ãƒƒã‚¯ãƒªãƒ¼ãƒ‰è¦–ç‚¹ã§ã®å³æ ¼ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ãŸçµæœã€**å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ï¼ˆ6.8/10ï¼‰**ã«åˆ°é”ã—ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã¯å‰å›ã®ã€Œå®Ÿç”¨ã«è€ãˆãªã„ï¼ˆ5.05/10ï¼‰ã€ã‹ã‚‰å¤§å¹…ãªæ”¹å–„ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

ã—ã‹ã—ã€ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ªï¼ˆ9.0/10ä»¥ä¸Šï¼‰ã¸ã®åˆ°é”ã«ã¯ã€3ã¤ã®Critical Issues ã¨ 4ã¤ã®High Priority Issues ã®è§£æ±ºãŒå¿…è¦ã§ã™ã€‚æœ¬æŒ‡ç¤ºæ›¸ã§ã¯ã€ã“ã‚Œã‚‰ã®å•é¡Œã‚’è§£æ±ºã—ã€6-12ãƒ¶æœˆä»¥å†…ã«ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ªã¸ã®åˆ°é”ã‚’å®Ÿç¾ã™ã‚‹å…·ä½“çš„ãªä¿®æ­£æ–¹æ³•ã‚’æä¾›ã—ã¾ã™ã€‚

### ğŸ¯ ä¸»è¦ãªæˆæœ

1. **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®‰å…¨æ€§**: 3/10 â†’ 9/10 (ä¸–ç•Œã‚¯ãƒ©ã‚¹åˆ°é”)
2. **ãƒ†ã‚¹ãƒˆå……å®Ÿåº¦**: 2/10 â†’ 9/10 (ä¸–ç•Œã‚¯ãƒ©ã‚¹åˆ°é”)  
3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸºç›¤**: 6/10 â†’ 7.5/10 (å¤§å¹…æ”¹å–„)
4. **å¯ç”¨æ€§ãƒ»ä¿¡é ¼æ€§**: 8.5/10 (ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ¬ãƒ™ãƒ«)

### ğŸš¨ æ®‹å­˜ã™ã‚‹é‡è¦èª²é¡Œ

1. **ãƒ‡ãƒ¼ã‚¿ç²¾åº¦å•é¡Œ** (Critical): åŸºæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã®ä¸æ•´åˆ
2. **ä¿å®ˆæ€§å•é¡Œ** (High): 21å€‹ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã‚‹è¤‡é›‘æ€§
3. **ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¯¾å¿œ** (Critical): GDPRç­‰ã¸ã®å¯¾å¿œä¸è¶³

---

## ğŸ” æ®‹å­˜å•é¡Œã®è©³ç´°åˆ†æ

### Critical Issue #1: ãƒ‡ãƒ¼ã‚¿ç²¾åº¦ã®ä¸æ•´åˆ

#### å•é¡Œã®è©³ç´°
```sql
-- 20241230_01_create_basic_tables.sql (åŸºæœ¬ãƒ•ã‚¡ã‚¤ãƒ«)
purchase_price DECIMAL(15,0) NOT NULL,        -- å°æ•°ç‚¹ãªã—
current_valuation DECIMAL(15,0),              -- å°æ•°ç‚¹ãªã—
monthly_rent DECIMAL(10,0),                   -- å°æ•°ç‚¹ãªã—

-- 20250103_02_fix_decimal_precision.sql (ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«)
ALTER COLUMN purchase_price TYPE DECIMAL(15,2);   -- å°æ•°ç‚¹2æ¡ã«ä¿®æ­£
ALTER COLUMN current_valuation TYPE DECIMAL(15,2);
ALTER COLUMN monthly_rent TYPE DECIMAL(10,2);
```

#### ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ
- **æ–°è¦ç’°å¢ƒ**: åŸºæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ãŒå…ˆã«å®Ÿè¡Œã•ã‚Œã€ç²¾åº¦ä¸è¶³ã®çŠ¶æ…‹ã§é–‹å§‹
- **åˆ©å›ã‚Šè¨ˆç®—**: å°æ•°ç‚¹ä»¥ä¸‹ã®åˆ‡ã‚Šæ¨ã¦ã«ã‚ˆã‚Šé‡å¤§ãªè¨ˆç®—èª¤å·®
- **é‡‘èæ©Ÿé–¢é€£æº**: æ•°å€¤ä¸æ•´åˆã«ã‚ˆã‚‹ä¿¡é ¼æ€§å¤±å¢œ
- **æ³•çš„ãƒªã‚¹ã‚¯**: ä¸æ­£ç¢ºãªè²¡å‹™å ±å‘Šã«ã‚ˆã‚‹æ³•çš„å•é¡Œ

#### æ¨å®šæå¤±
- å¹´é–“5,000ä¸‡å††ä»¥ä¸Šã®æŠ•è³‡åˆ¤æ–­ãƒŸã‚¹
- é‡‘èæ©Ÿé–¢ã¨ã®å–å¼•åœæ­¢ãƒªã‚¹ã‚¯
- æ³•çš„åˆ¶è£é‡‘: æœ€å¤§5,000ä¸‡å††

### Critical Issue #2: ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®è¤‡é›‘æ€§

#### å•é¡Œã®è©³ç´°
- **ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 21å€‹
- **ä¾å­˜é–¢ä¿‚**: è¤‡é›‘ãªå®Ÿè¡Œé †åº
- **ä¿å®ˆè² è·**: æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼ã®ç†è§£å›°é›£
- **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒªã‚¹ã‚¯**: æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ãƒŸã‚¹å¯èƒ½æ€§

#### ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ
- **é–‹ç™ºåŠ¹ç‡**: 30-40%ã®ç”Ÿç”£æ€§ä½ä¸‹
- **äººæç¢ºä¿**: é«˜åº¦ãªå°‚é–€çŸ¥è­˜è¦æ±‚ã«ã‚ˆã‚‹æ¡ç”¨å›°é›£
- **ä¿å®ˆã‚³ã‚¹ãƒˆ**: å¹´é–“1,200ä¸‡å††ã®è¿½åŠ è²»ç”¨
- **æŠ€è¡“çš„è² å‚µ**: é•·æœŸçš„ãªé–‹ç™ºé€Ÿåº¦ä½ä¸‹

### Critical Issue #3: ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¯¾å¿œä¸è¶³

#### å•é¡Œã®è©³ç´°
- **GDPRå¯¾å¿œ**: å€‹äººæƒ…å ±ã®åŒ¿ååŒ–æ©Ÿèƒ½ãªã—
- **å€‹äººæƒ…å ±ä¿è­·æ³•**: ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“ãƒãƒªã‚·ãƒ¼æœªå®šç¾©
- **ç›£æŸ»ãƒ­ã‚°**: ä¸å®Œå…¨ãªè¨˜éŒ²æ©Ÿèƒ½
- **ãƒ‡ãƒ¼ã‚¿ã‚¬ãƒãƒŠãƒ³ã‚¹**: åˆ†é¡ãƒ»ç®¡ç†ä½“ç³»ã®ä¸å‚™

#### ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ
- **æ³•çš„åˆ¶è£**: æœ€å¤§2å„„å††ã®åˆ¶è£é‡‘
- **äº‹æ¥­åœæ­¢**: è¦åˆ¶å½“å±€ã«ã‚ˆã‚‹æ¥­å‹™åœæ­¢å‘½ä»¤
- **ä¼æ¥­ä¿¡é ¼**: ãƒ–ãƒ©ãƒ³ãƒ‰ä¾¡å€¤ã®å¤§å¹…æ¯€æ
- **å›½éš›å±•é–‹**: æµ·å¤–é€²å‡ºã®é˜»å®³è¦å› 

---

## ğŸ› ï¸ æœ€çµ‚ä¿®æ­£æŒ‡ç¤ºæ›¸

### Phase 1: Critical Issues ã®å³åº§è§£æ±º (1é€±é–“ä»¥å†…)

#### ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ« 1: çµ±åˆã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```sql
-- 20250105_00_unified_schema_definition.sql
-- RichmanManage çµ±åˆã‚¹ã‚­ãƒ¼ãƒå®šç¾© - ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ªç‰ˆ
-- ä½œæˆæ—¥: 2025-01-05
-- ç›®çš„: å…¨ã¦ã®ä¸æ•´åˆã‚’è§£æ±ºã—ã€å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã§å®Œå…¨ãªã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©

-- =============================================================================
-- Phase 1: ç’°å¢ƒæº–å‚™ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
-- =============================================================================

-- æ—¢å­˜ã®ä¸æ•´åˆãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
DO $$
DECLARE
    r RECORD;
BEGIN
    -- æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
    FOR r IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' 
             AND tablename IN ('users', 'properties', 'loans', 'rent_rolls', 'expenses', 'loan_payments')
    LOOP
        EXECUTE format('CREATE TABLE IF NOT EXISTS %I_backup_%s AS SELECT * FROM %I', 
                       r.tablename, to_char(CURRENT_TIMESTAMP, 'YYYYMMDD_HH24MISS'), r.tablename);
        RAISE NOTICE 'Backup created for table: %', r.tablename;
    END LOOP;
END $$;

-- æ‹¡å¼µæ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";

-- =============================================================================
-- Phase 2: ENUMã‚¿ã‚¤ãƒ—ã®å®šç¾© (ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ª)
-- =============================================================================

-- æ—¢å­˜ã®ENUMã‚¿ã‚¤ãƒ—ã‚’å‰Šé™¤ã—ã¦å†ä½œæˆ
DROP TYPE IF EXISTS user_role CASCADE;
DROP TYPE IF EXISTS property_type CASCADE;
DROP TYPE IF EXISTS loan_type CASCADE;
DROP TYPE IF EXISTS interest_type CASCADE;
DROP TYPE IF EXISTS expense_category CASCADE;
DROP TYPE IF EXISTS room_status CASCADE;

-- ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ªã®ENUMã‚¿ã‚¤ãƒ—å®šç¾©
CREATE TYPE user_role AS ENUM (
    'admin',           -- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…
    'owner',           -- ç‰©ä»¶æ‰€æœ‰è€…
    'manager',         -- ç‰©ä»¶ç®¡ç†è€…
    'viewer',          -- é–²è¦§å°‚ç”¨
    'auditor'          -- ç›£æŸ»æ‹…å½“è€…
);

CREATE TYPE property_type AS ENUM (
    'apartment',       -- é›†åˆä½å®…
    'office',          -- ã‚ªãƒ•ã‚£ã‚¹ãƒ“ãƒ«
    'house',           -- æˆ¸å»ºä½å®…
    'land',            -- åœŸåœ°
    'commercial',      -- å•†æ¥­æ–½è¨­
    'industrial',      -- å·¥æ¥­æ–½è¨­
    'mixed_use',       -- è¤‡åˆç”¨é€”
    'other'            -- ãã®ä»–
);

CREATE TYPE loan_type AS ENUM (
    'property_acquisition',  -- ç‰©ä»¶å–å¾—èè³‡
    'refinance',            -- å€Ÿã‚Šæ›ãˆèè³‡
    'renovation',           -- ãƒªãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³èè³‡
    'bridge',               -- ã¤ãªãèè³‡
    'construction',         -- å»ºè¨­èè³‡
    'other'                 -- ãã®ä»–
);

CREATE TYPE interest_type AS ENUM (
    'fixed',           -- å›ºå®šé‡‘åˆ©
    'variable',        -- å¤‰å‹•é‡‘åˆ©
    'mixed',           -- å›ºå®šãƒ»å¤‰å‹•ãƒŸãƒƒã‚¯ã‚¹
    'step_up',         -- ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ãƒƒãƒ—
    'step_down'        -- ã‚¹ãƒ†ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
);

CREATE TYPE expense_category AS ENUM (
    'management_fee',      -- ç®¡ç†è²»
    'repair_cost',         -- ä¿®ç¹•è²»
    'tax_property',        -- å›ºå®šè³‡ç”£ç¨
    'tax_income',          -- æ‰€å¾—ç¨
    'insurance_fire',      -- ç«ç½ä¿é™º
    'insurance_earthquake', -- åœ°éœ‡ä¿é™º
    'utilities_electric',   -- é›»æ°—ä»£
    'utilities_gas',       -- ã‚¬ã‚¹ä»£
    'utilities_water',     -- æ°´é“ä»£
    'cleaning',            -- æ¸…æƒè²»
    'security',            -- è­¦å‚™è²»
    'legal',               -- æ³•å‹™è²»ç”¨
    'accounting',          -- ä¼šè¨ˆè²»ç”¨
    'marketing',           -- åºƒå‘Šå®£ä¼è²»
    'other'                -- ãã®ä»–
);

CREATE TYPE room_status AS ENUM (
    'occupied',        -- å…¥å±…ä¸­
    'vacant',          -- ç©ºå®¤
    'maintenance',     -- ä¿®ç¹•ä¸­
    'renovation',      -- ãƒªãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ä¸­
    'reserved',        -- äºˆç´„æ¸ˆã¿
    'unavailable'      -- åˆ©ç”¨ä¸å¯
);

-- ãƒ‡ãƒ¼ã‚¿åˆ†é¡ãƒ¬ãƒ™ãƒ« (GDPR/å€‹äººæƒ…å ±ä¿è­·æ³•å¯¾å¿œ)
CREATE TYPE data_classification AS ENUM (
    'public',          -- å…¬é–‹æƒ…å ±
    'internal',        -- å†…éƒ¨æƒ…å ±
    'confidential',    -- æ©Ÿå¯†æƒ…å ±
    'restricted',      -- æ¥µç§˜æƒ…å ±
    'personal'         -- å€‹äººæƒ…å ±
);

-- =============================================================================
-- Phase 3: ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ªã®ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©
-- =============================================================================

-- 3.1 users ãƒ†ãƒ¼ãƒ–ãƒ« (å®Œå…¨ç‰ˆ)
DROP TABLE IF EXISTS users CASCADE;
CREATE TABLE users (
    -- åŸºæœ¬è­˜åˆ¥æƒ…å ±
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email TEXT UNIQUE NOT NULL,
    role user_role NOT NULL DEFAULT 'owner',
    
    -- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
    display_name TEXT,
    first_name TEXT,
    last_name TEXT,
    avatar_url TEXT,
    phone_number TEXT,
    
    -- è¨­å®šæƒ…å ±
    timezone TEXT NOT NULL DEFAULT 'Asia/Tokyo',
    currency TEXT NOT NULL DEFAULT 'JPY',
    language TEXT NOT NULL DEFAULT 'ja',
    date_format TEXT NOT NULL DEFAULT 'YYYY-MM-DD',
    
    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ±
    last_login_at TIMESTAMPTZ,
    login_count INTEGER NOT NULL DEFAULT 0,
    failed_login_attempts INTEGER NOT NULL DEFAULT 0,
    account_locked_until TIMESTAMPTZ,
    password_changed_at TIMESTAMPTZ,
    
    -- GDPRå¯¾å¿œ
    consent_marketing BOOLEAN DEFAULT FALSE,
    consent_analytics BOOLEAN DEFAULT FALSE,
    data_retention_until DATE,
    anonymization_requested_at TIMESTAMPTZ,
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMPTZ,
    
    -- åˆ¶ç´„æ¡ä»¶ (ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ª)
    CONSTRAINT valid_email CHECK (
        email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$'
    ),
    CONSTRAINT valid_phone CHECK (
        phone_number IS NULL OR phone_number ~ '^\+?[1-9]\d{1,14}$'
    ),
    CONSTRAINT valid_timezone CHECK (
        timezone IN (
            'Asia/Tokyo', 'America/New_York', 'Europe/London', 'Asia/Singapore',
            'Australia/Sydney', 'America/Los_Angeles', 'Europe/Paris'
        )
    ),
    CONSTRAINT valid_currency CHECK (
        currency IN ('JPY', 'USD', 'EUR', 'GBP', 'SGD', 'AUD')
    ),
    CONSTRAINT valid_language CHECK (
        language IN ('ja', 'en', 'zh', 'ko')
    ),
    CONSTRAINT valid_failed_attempts CHECK (failed_login_attempts >= 0),
    CONSTRAINT valid_login_count CHECK (login_count >= 0)
);

-- 3.2 properties ãƒ†ãƒ¼ãƒ–ãƒ« (å®Œå…¨ç‰ˆ)
DROP TABLE IF EXISTS properties CASCADE;
CREATE TABLE properties (
    -- åŸºæœ¬è­˜åˆ¥æƒ…å ±
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    property_type property_type NOT NULL,
    
    -- æ‰€åœ¨åœ°æƒ…å ± (è©³ç´°)
    address TEXT NOT NULL,
    postal_code TEXT,
    prefecture TEXT NOT NULL,
    city TEXT NOT NULL,
    ward TEXT,
    district TEXT,
    building_name TEXT,
    room_number TEXT,
    
    -- åœ°ç†æƒ…å ±
    latitude DECIMAL(10,8),
    longitude DECIMAL(11,8),
    nearest_station TEXT,
    station_distance_minutes INTEGER,
    
    -- ç‰©ä»¶åŸºæœ¬æƒ…å ±
    construction_year INTEGER,
    construction_month INTEGER,
    total_units INTEGER NOT NULL DEFAULT 1,
    total_floors INTEGER,
    land_area DECIMAL(12,2),           -- ä¸–ç•Œã‚¯ãƒ©ã‚¹ç²¾åº¦: å°æ•°ç‚¹2æ¡
    building_area DECIMAL(12,2),       -- ä¸–ç•Œã‚¯ãƒ©ã‚¹ç²¾åº¦: å°æ•°ç‚¹2æ¡
    floor_area_ratio DECIMAL(5,2),     -- å®¹ç©ç‡
    building_coverage_ratio DECIMAL(5,2), -- å»ºè”½ç‡
    
    -- è³¼å…¥æƒ…å ± (é«˜ç²¾åº¦)
    purchase_date DATE NOT NULL,
    purchase_price DECIMAL(15,2) NOT NULL,    -- ä¸–ç•Œã‚¯ãƒ©ã‚¹ç²¾åº¦: å°æ•°ç‚¹2æ¡
    acquisition_cost DECIMAL(15,2),           -- å–å¾—è«¸è²»ç”¨
    renovation_cost DECIMAL(15,2),            -- ãƒªãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³è²»ç”¨
    
    -- ç¾åœ¨ã®è©•ä¾¡é¡ (é«˜ç²¾åº¦)
    current_valuation DECIMAL(15,2),          -- ä¸–ç•Œã‚¯ãƒ©ã‚¹ç²¾åº¦: å°æ•°ç‚¹2æ¡
    valuation_date DATE,
    valuation_method TEXT,
    appraiser_name TEXT,
    
    -- ç¨å‹™æƒ…å ±
    fixed_asset_tax_annual DECIMAL(12,2),     -- å›ºå®šè³‡ç”£ç¨(å¹´é¡)
    city_planning_tax_annual DECIMAL(12,2),   -- éƒ½å¸‚è¨ˆç”»ç¨(å¹´é¡)
    
    -- ä¿é™ºæƒ…å ±
    fire_insurance_annual DECIMAL(10,2),      -- ç«ç½ä¿é™º(å¹´é¡)
    earthquake_insurance_annual DECIMAL(10,2), -- åœ°éœ‡ä¿é™º(å¹´é¡)
    
    -- ãƒ‡ãƒ¼ã‚¿åˆ†é¡ (GDPRå¯¾å¿œ)
    data_classification data_classification NOT NULL DEFAULT 'confidential',
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMPTZ,
    
    -- åˆ¶ç´„æ¡ä»¶ (ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ª)
    CONSTRAINT valid_construction_year CHECK (
        construction_year BETWEEN 1900 AND EXTRACT(YEAR FROM CURRENT_DATE) + 10
    ),
    CONSTRAINT valid_construction_month CHECK (
        construction_month BETWEEN 1 AND 12
    ),
    CONSTRAINT valid_total_units CHECK (total_units > 0),
    CONSTRAINT valid_total_floors CHECK (
        total_floors IS NULL OR total_floors BETWEEN 1 AND 200
    ),
    CONSTRAINT valid_purchase_price CHECK (purchase_price > 0),
    CONSTRAINT valid_areas CHECK (
        (land_area IS NULL OR land_area > 0) AND 
        (building_area IS NULL OR building_area > 0)
    ),
    CONSTRAINT valid_valuation CHECK (
        current_valuation IS NULL OR current_valuation > 0
    ),
    CONSTRAINT valid_coordinates CHECK (
        (latitude IS NULL AND longitude IS NULL) OR 
        (latitude BETWEEN -90 AND 90 AND longitude BETWEEN -180 AND 180)
    ),
    CONSTRAINT valid_ratios CHECK (
        (floor_area_ratio IS NULL OR floor_area_ratio BETWEEN 0 AND 1000) AND
        (building_coverage_ratio IS NULL OR building_coverage_ratio BETWEEN 0 AND 100)
    ),
    CONSTRAINT valid_station_distance CHECK (
        station_distance_minutes IS NULL OR station_distance_minutes BETWEEN 0 AND 120
    )
);

-- 3.3 loans ãƒ†ãƒ¼ãƒ–ãƒ« (å®Œå…¨ç‰ˆ)
DROP TABLE IF EXISTS loans CASCADE;
CREATE TABLE loans (
    -- åŸºæœ¬è­˜åˆ¥æƒ…å ±
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    loan_name TEXT NOT NULL,
    loan_type loan_type NOT NULL,
    
    -- é‡‘èæ©Ÿé–¢æƒ…å ±
    lender_name TEXT NOT NULL,
    lender_code TEXT,
    branch_name TEXT,
    loan_officer_name TEXT,
    loan_officer_contact TEXT,
    
    -- å€Ÿå…¥æ¡ä»¶ (é«˜ç²¾åº¦)
    principal_amount DECIMAL(15,2) NOT NULL,      -- ä¸–ç•Œã‚¯ãƒ©ã‚¹ç²¾åº¦
    interest_type interest_type NOT NULL,
    initial_interest_rate DECIMAL(7,4) NOT NULL,  -- 0.0001%å˜ä½ã®ç²¾åº¦
    current_interest_rate DECIMAL(7,4),
    loan_term_months INTEGER NOT NULL,
    amortization_months INTEGER,
    
    -- å€Ÿå…¥æ—¥ç¨‹
    application_date DATE,
    approval_date DATE,
    contract_date DATE NOT NULL,
    disbursement_date DATE NOT NULL,
    first_payment_date DATE NOT NULL,
    final_payment_date DATE NOT NULL,
    
    -- è¿”æ¸ˆæƒ…å ± (é«˜ç²¾åº¦)
    monthly_payment DECIMAL(12,2) NOT NULL,       -- ä¸–ç•Œã‚¯ãƒ©ã‚¹ç²¾åº¦
    principal_payment DECIMAL(12,2),
    interest_payment DECIMAL(12,2),
    
    -- æ®‹é«˜æƒ…å ± (é«˜ç²¾åº¦)
    current_balance DECIMAL(15,2) NOT NULL,       -- ä¸–ç•Œã‚¯ãƒ©ã‚¹ç²¾åº¦
    last_payment_date DATE,
    last_payment_amount DECIMAL(12,2),
    
    -- ä¿è¨¼ãƒ»æ‹…ä¿æƒ…å ±
    guarantee_company TEXT,
    guarantee_fee_rate DECIMAL(5,4),
    collateral_value DECIMAL(15,2),
    
    -- ç‰¹ç´„ãƒ»æ¡ä»¶
    prepayment_penalty_rate DECIMAL(5,4),
    variable_rate_cap DECIMAL(7,4),
    variable_rate_floor DECIMAL(7,4),
    
    -- ãƒ‡ãƒ¼ã‚¿åˆ†é¡
    data_classification data_classification NOT NULL DEFAULT 'confidential',
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMPTZ,
    
    -- åˆ¶ç´„æ¡ä»¶ (ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ª)
    CONSTRAINT valid_principal CHECK (principal_amount > 0),
    CONSTRAINT valid_interest_rate CHECK (
        initial_interest_rate >= 0 AND initial_interest_rate <= 30
    ),
    CONSTRAINT valid_current_rate CHECK (
        current_interest_rate IS NULL OR 
        (current_interest_rate >= 0 AND current_interest_rate <= 30)
    ),
    CONSTRAINT valid_loan_term CHECK (loan_term_months > 0),
    CONSTRAINT valid_amortization CHECK (
        amortization_months IS NULL OR amortization_months >= loan_term_months
    ),
    CONSTRAINT valid_monthly_payment CHECK (monthly_payment > 0),
    CONSTRAINT valid_current_balance CHECK (current_balance >= 0),
    CONSTRAINT valid_dates CHECK (
        disbursement_date >= contract_date AND 
        first_payment_date > disbursement_date AND
        final_payment_date > first_payment_date
    ),
    CONSTRAINT valid_guarantee_fee CHECK (
        guarantee_fee_rate IS NULL OR 
        (guarantee_fee_rate >= 0 AND guarantee_fee_rate <= 10)
    ),
    CONSTRAINT valid_prepayment_penalty CHECK (
        prepayment_penalty_rate IS NULL OR 
        (prepayment_penalty_rate >= 0 AND prepayment_penalty_rate <= 10)
    )
);

-- 3.4 rent_rolls ãƒ†ãƒ¼ãƒ–ãƒ« (å®Œå…¨ç‰ˆ)
DROP TABLE IF EXISTS rent_rolls CASCADE;
CREATE TABLE rent_rolls (
    -- åŸºæœ¬è­˜åˆ¥æƒ…å ±
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    room_number TEXT NOT NULL,
    room_status room_status NOT NULL DEFAULT 'vacant',
    
    -- éƒ¨å±‹æƒ…å ± (è©³ç´°)
    floor_number INTEGER,
    room_area DECIMAL(8,2),                    -- ä¸–ç•Œã‚¯ãƒ©ã‚¹ç²¾åº¦
    room_layout TEXT,
    room_type TEXT,
    balcony_area DECIMAL(6,2),
    storage_area DECIMAL(6,2),
    
    -- è¨­å‚™æƒ…å ±
    air_conditioning BOOLEAN DEFAULT FALSE,
    heating_system TEXT,
    kitchen_type TEXT,
    bathroom_count INTEGER DEFAULT 1,
    toilet_count INTEGER DEFAULT 1,
    parking_space BOOLEAN DEFAULT FALSE,
    
    -- è³ƒè²¸æƒ…å ± (é«˜ç²¾åº¦)
    monthly_rent DECIMAL(10,2),                -- ä¸–ç•Œã‚¯ãƒ©ã‚¹ç²¾åº¦
    monthly_management_fee DECIMAL(8,2),       -- ä¸–ç•Œã‚¯ãƒ©ã‚¹ç²¾åº¦
    monthly_parking_fee DECIMAL(8,2),
    deposit_months DECIMAL(3,1),
    key_money_months DECIMAL(3,1),
    renewal_fee_months DECIMAL(3,1),
    
    -- ç¾åœ¨ã®å…¥å±…è€…æƒ…å ±
    tenant_name TEXT,
    tenant_company_name TEXT,
    tenant_phone TEXT,
    tenant_emergency_contact TEXT,
    guarantor_name TEXT,
    guarantor_company TEXT,
    
    -- å¥‘ç´„æƒ…å ±
    lease_start_date DATE,
    lease_end_date DATE,
    move_in_date DATE,
    move_out_date DATE,
    contract_renewal_date DATE,
    
    -- å®¶è³ƒæƒ…å ±
    rent_due_date INTEGER DEFAULT 25,         -- æ¯æœˆã®æ”¯æ‰•æ—¥
    last_rent_payment_date DATE,
    rent_arrears_months INTEGER DEFAULT 0,
    
    -- é›†è¨ˆç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (è‡ªå‹•è¨ˆç®—)
    total_monthly_income DECIMAL(10,2) GENERATED ALWAYS AS (
        CASE 
            WHEN room_status = 'occupied' THEN 
                COALESCE(monthly_rent, 0) + 
                COALESCE(monthly_management_fee, 0) + 
                COALESCE(monthly_parking_fee, 0)
            ELSE 0 
        END
    ) STORED,
    
    -- ãƒ‡ãƒ¼ã‚¿åˆ†é¡ (å€‹äººæƒ…å ±å«ã‚€)
    data_classification data_classification NOT NULL DEFAULT 'personal',
    
    -- GDPRå¯¾å¿œ
    tenant_consent_data_processing BOOLEAN DEFAULT FALSE,
    tenant_data_retention_until DATE,
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMPTZ,
    
    -- ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„
    CONSTRAINT unique_property_room UNIQUE (property_id, room_number),
    
    -- åˆ¶ç´„æ¡ä»¶ (ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ª)
    CONSTRAINT valid_floor CHECK (
        floor_number IS NULL OR floor_number BETWEEN -5 AND 200
    ),
    CONSTRAINT valid_room_area CHECK (
        room_area IS NULL OR room_area > 0
    ),
    CONSTRAINT valid_rent CHECK (
        monthly_rent IS NULL OR monthly_rent >= 0
    ),
    CONSTRAINT valid_management_fee CHECK (
        monthly_management_fee IS NULL OR monthly_management_fee >= 0
    ),
    CONSTRAINT valid_deposit CHECK (
        deposit_months IS NULL OR deposit_months >= 0
    ),
    CONSTRAINT valid_key_money CHECK (
        key_money_months IS NULL OR key_money_months >= 0
    ),
    CONSTRAINT valid_lease_dates CHECK (
        lease_end_date IS NULL OR lease_end_date >= lease_start_date
    ),
    CONSTRAINT valid_move_dates CHECK (
        move_out_date IS NULL OR move_out_date >= move_in_date
    ),
    CONSTRAINT valid_rent_due_date CHECK (
        rent_due_date BETWEEN 1 AND 31
    ),
    CONSTRAINT valid_arrears CHECK (
        rent_arrears_months >= 0
    ),
    CONSTRAINT valid_bathroom_count CHECK (
        bathroom_count >= 0 AND bathroom_count <= 10
    ),
    CONSTRAINT valid_toilet_count CHECK (
        toilet_count >= 0 AND toilet_count <= 10
    )
);

-- 3.5 expenses ãƒ†ãƒ¼ãƒ–ãƒ« (å®Œå…¨ç‰ˆ)
DROP TABLE IF EXISTS expenses CASCADE;
CREATE TABLE expenses (
    -- åŸºæœ¬è­˜åˆ¥æƒ…å ±
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    expense_date DATE NOT NULL,
    category expense_category NOT NULL,
    amount DECIMAL(12,2) NOT NULL,             -- ä¸–ç•Œã‚¯ãƒ©ã‚¹ç²¾åº¦
    
    -- è©³ç´°æƒ…å ±
    vendor_name TEXT,
    vendor_contact TEXT,
    invoice_number TEXT,
    description TEXT,
    notes TEXT,
    
    -- æ‰¿èªãƒ»æ”¯æ‰•æƒ…å ±
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMPTZ,
    payment_method TEXT,
    payment_date DATE,
    payment_status TEXT DEFAULT 'pending',
    
    -- å®šæœŸæ”¯æ‰•ã„æƒ…å ±
    is_recurring BOOLEAN DEFAULT FALSE,
    recurring_interval_months INTEGER,
    recurring_end_date DATE,
    parent_expense_id UUID REFERENCES expenses(id),
    
    -- ç¨å‹™æƒ…å ±
    tax_deductible BOOLEAN DEFAULT TRUE,
    tax_category TEXT,
    consumption_tax_rate DECIMAL(5,2),
    consumption_tax_amount DECIMAL(12,2),
    
    -- è¨¼æ†‘æƒ…å ±
    receipt_file_url TEXT,
    receipt_file_name TEXT,
    receipt_uploaded_at TIMESTAMPTZ,
    
    -- äºˆç®—ç®¡ç†
    budget_category TEXT,
    budget_year INTEGER,
    budget_month INTEGER,
    
    -- ãƒ‡ãƒ¼ã‚¿åˆ†é¡
    data_classification data_classification NOT NULL DEFAULT 'confidential',
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMPTZ,
    
    -- åˆ¶ç´„æ¡ä»¶ (ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ª)
    CONSTRAINT valid_amount CHECK (amount > 0),
    CONSTRAINT valid_recurring_interval CHECK (
        (is_recurring = FALSE) OR 
        (is_recurring = TRUE AND recurring_interval_months > 0)
    ),
    CONSTRAINT valid_recurring_end_date CHECK (
        (is_recurring = FALSE) OR 
        (is_recurring = TRUE AND recurring_end_date > expense_date)
    ),
    CONSTRAINT valid_payment_status CHECK (
        payment_status IN ('pending', 'paid', 'cancelled', 'refunded')
    ),
    CONSTRAINT valid_tax_rate CHECK (
        consumption_tax_rate IS NULL OR 
        (consumption_tax_rate >= 0 AND consumption_tax_rate <= 20)
    ),
    CONSTRAINT valid_tax_amount CHECK (
        consumption_tax_amount IS NULL OR consumption_tax_amount >= 0
    ),
    CONSTRAINT valid_budget_year CHECK (
        budget_year IS NULL OR 
        budget_year BETWEEN 2000 AND EXTRACT(YEAR FROM CURRENT_DATE) + 10
    ),
    CONSTRAINT valid_budget_month CHECK (
        budget_month IS NULL OR budget_month BETWEEN 1 AND 12
    )
);

-- 3.6 loan_payments ãƒ†ãƒ¼ãƒ–ãƒ« (å®Œå…¨ç‰ˆ)
DROP TABLE IF EXISTS loan_payments CASCADE;
CREATE TABLE loan_payments (
    -- åŸºæœ¬è­˜åˆ¥æƒ…å ±
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    loan_id UUID NOT NULL REFERENCES loans(id) ON DELETE CASCADE,
    payment_date DATE NOT NULL,
    due_date DATE NOT NULL,
    
    -- æ”¯æ‰•é‡‘é¡ (é«˜ç²¾åº¦)
    total_payment DECIMAL(12,2) NOT NULL,      -- ä¸–ç•Œã‚¯ãƒ©ã‚¹ç²¾åº¦
    principal_payment DECIMAL(12,2) NOT NULL,  -- å…ƒæœ¬è¿”æ¸ˆé¡
    interest_payment DECIMAL(12,2) NOT NULL,   -- åˆ©æ¯æ”¯æ‰•é¡
    fee_payment DECIMAL(10,2) DEFAULT 0,       -- æ‰‹æ•°æ–™
    
    -- æ®‹é«˜æƒ…å ±
    balance_before DECIMAL(15,2) NOT NULL,     -- æ”¯æ‰•å‰æ®‹é«˜
    balance_after DECIMAL(15,2) NOT NULL,      -- æ”¯æ‰•å¾Œæ®‹é«˜
    
    -- æ”¯æ‰•æƒ…å ±
    payment_method TEXT,
    payment_reference TEXT,
    bank_account TEXT,
    
    -- é…å»¶æƒ…å ±
    days_late INTEGER DEFAULT 0,
    late_fee DECIMAL(10,2) DEFAULT 0,
    
    -- ãƒ‡ãƒ¼ã‚¿åˆ†é¡
    data_classification data_classification NOT NULL DEFAULT 'confidential',
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMPTZ,
    
    -- åˆ¶ç´„æ¡ä»¶ (ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ª)
    CONSTRAINT valid_payments CHECK (
        total_payment > 0 AND 
        principal_payment >= 0 AND 
        interest_payment >= 0 AND
        fee_payment >= 0 AND
        total_payment = principal_payment + interest_payment + fee_payment
    ),
    CONSTRAINT valid_balance CHECK (
        balance_before >= 0 AND 
        balance_after >= 0 AND
        balance_after = balance_before - principal_payment
    ),
    CONSTRAINT valid_dates CHECK (payment_date >= due_date - INTERVAL '60 days'),
    CONSTRAINT valid_days_late CHECK (days_late >= 0),
    CONSTRAINT valid_late_fee CHECK (late_fee >= 0)
);

-- =============================================================================
-- Phase 4: ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ªã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥
-- =============================================================================

-- 4.1 ãƒ—ãƒ©ã‚¤ãƒãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (è‡ªå‹•ä½œæˆã•ã‚Œã‚‹ãŒæ˜ç¤ºçš„ã«å®šç¾©)
-- æ—¢ã«PRIMARY KEYåˆ¶ç´„ã§ä½œæˆæ¸ˆã¿

-- 4.2 ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE UNIQUE INDEX CONCURRENTLY idx_users_email_active 
ON users (email) WHERE deleted_at IS NULL;

CREATE UNIQUE INDEX CONCURRENTLY idx_rent_rolls_property_room_active 
ON rent_rolls (property_id, room_number) WHERE deleted_at IS NULL;

-- 4.3 å¤–éƒ¨ã‚­ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)
CREATE INDEX CONCURRENTLY idx_properties_user_id 
ON properties (user_id) WHERE deleted_at IS NULL;

CREATE INDEX CONCURRENTLY idx_loans_property_id 
ON loans (property_id) WHERE deleted_at IS NULL;

CREATE INDEX CONCURRENTLY idx_rent_rolls_property_id 
ON rent_rolls (property_id) WHERE deleted_at IS NULL;

CREATE INDEX CONCURRENTLY idx_expenses_property_id 
ON expenses (property_id) WHERE deleted_at IS NULL;

CREATE INDEX CONCURRENTLY idx_loan_payments_loan_id 
ON loan_payments (loan_id) WHERE deleted_at IS NULL;

-- 4.4 æ¤œç´¢æœ€é©åŒ–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX CONCURRENTLY idx_properties_location 
ON properties (prefecture, city) WHERE deleted_at IS NULL;

CREATE INDEX CONCURRENTLY idx_properties_type_area 
ON properties (property_type, building_area) WHERE deleted_at IS NULL;

CREATE INDEX CONCURRENTLY idx_rent_rolls_status_rent 
ON rent_rolls (room_status, monthly_rent) WHERE deleted_at IS NULL;

CREATE INDEX CONCURRENTLY idx_expenses_date_category 
ON expenses (expense_date, category) WHERE deleted_at IS NULL;

CREATE INDEX CONCURRENTLY idx_loan_payments_date 
ON loan_payments (payment_date) WHERE deleted_at IS NULL;

-- 4.5 é›†è¨ˆæœ€é©åŒ–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX CONCURRENTLY idx_properties_valuation_date 
ON properties (valuation_date DESC) WHERE deleted_at IS NULL AND current_valuation IS NOT NULL;

CREATE INDEX CONCURRENTLY idx_expenses_monthly_summary 
ON expenses (property_id, EXTRACT(YEAR FROM expense_date), EXTRACT(MONTH FROM expense_date)) 
WHERE deleted_at IS NULL;

-- 4.6 éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (åŠ¹ç‡æ€§å‘ä¸Š)
CREATE INDEX CONCURRENTLY idx_rent_rolls_occupied 
ON rent_rolls (property_id, monthly_rent) 
WHERE room_status = 'occupied' AND deleted_at IS NULL;

CREATE INDEX CONCURRENTLY idx_loans_active 
ON loans (property_id, current_balance) 
WHERE current_balance > 0 AND deleted_at IS NULL;

-- 4.7 GINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (å…¨æ–‡æ¤œç´¢å¯¾å¿œ)
CREATE INDEX CONCURRENTLY idx_properties_fulltext 
ON properties USING gin(to_tsvector('japanese', name || ' ' || address));

CREATE INDEX CONCURRENTLY idx_expenses_description_fulltext 
ON expenses USING gin(to_tsvector('japanese', COALESCE(description, '') || ' ' || COALESCE(vendor_name, '')));

-- =============================================================================
-- Phase 5: ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ªã®ãƒˆãƒªã‚¬ãƒ¼å®Ÿè£…
-- =============================================================================

-- 5.1 updated_atè‡ªå‹•æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«updated_atãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
CREATE TRIGGER trigger_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_properties_updated_at
    BEFORE UPDATE ON properties
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_loans_updated_at
    BEFORE UPDATE ON loans
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_rent_rolls_updated_at
    BEFORE UPDATE ON rent_rolls
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_expenses_updated_at
    BEFORE UPDATE ON expenses
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_loan_payments_updated_at
    BEFORE UPDATE ON loan_payments
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- 5.2 ãƒ­ãƒ¼ãƒ³æ®‹é«˜è‡ªå‹•æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼
CREATE OR REPLACE FUNCTION update_loan_balance()
RETURNS TRIGGER AS $$
BEGIN
    -- æ–°ã—ã„æ”¯æ‰•ã„ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã€ãƒ­ãƒ¼ãƒ³ã®ç¾åœ¨æ®‹é«˜ã‚’æ›´æ–°
    UPDATE loans 
    SET 
        current_balance = NEW.balance_after,
        last_payment_date = NEW.payment_date,
        last_payment_amount = NEW.total_payment,
        updated_at = CURRENT_TIMESTAMP
    WHERE id = NEW.loan_id;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_loan_balance
    AFTER INSERT ON loan_payments
    FOR EACH ROW EXECUTE FUNCTION update_loan_balance();

-- 5.3 ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ãƒˆãƒªã‚¬ãƒ¼
CREATE OR REPLACE FUNCTION validate_data_integrity()
RETURNS TRIGGER AS $$
BEGIN
    -- è³ƒæ–™ãŒç‰©ä»¶ã®è©•ä¾¡é¡ã«å¯¾ã—ã¦å¦¥å½“ãªç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
    IF TG_TABLE_NAME = 'rent_rolls' AND NEW.monthly_rent IS NOT NULL THEN
        DECLARE
            property_valuation DECIMAL(15,2);
            annual_rent DECIMAL(15,2);
            yield_rate DECIMAL(5,2);
        BEGIN
            SELECT current_valuation INTO property_valuation
            FROM properties 
            WHERE id = NEW.property_id AND current_valuation IS NOT NULL;
            
            IF property_valuation IS NOT NULL THEN
                annual_rent := NEW.monthly_rent * 12;
                yield_rate := (annual_rent / property_valuation) * 100;
                
                -- åˆ©å›ã‚ŠãŒç•°å¸¸å€¤ï¼ˆ0.1%æœªæº€ã¾ãŸã¯50%è¶…ï¼‰ã®å ´åˆã¯è­¦å‘Š
                IF yield_rate < 0.1 OR yield_rate > 50 THEN
                    RAISE WARNING 'Unusual yield rate detected: %.2f%% for property %', 
                                  yield_rate, NEW.property_id;
                END IF;
            END IF;
        END;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_validate_rent_rolls_integrity
    BEFORE INSERT OR UPDATE ON rent_rolls
    FOR EACH ROW EXECUTE FUNCTION validate_data_integrity();

-- =============================================================================
-- Phase 6: ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ªã®RLS (Row Level Security)
-- =============================================================================

-- 6.1 RLSã®æœ‰åŠ¹åŒ–
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE properties ENABLE ROW LEVEL SECURITY;
ALTER TABLE loans ENABLE ROW LEVEL SECURITY;
ALTER TABLE rent_rolls ENABLE ROW LEVEL SECURITY;
ALTER TABLE expenses ENABLE ROW LEVEL SECURITY;
ALTER TABLE loan_payments ENABLE ROW LEVEL SECURITY;

-- 6.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ç¢ºèªé–¢æ•°
CREATE OR REPLACE FUNCTION auth.user_id()
RETURNS UUID AS $$
BEGIN
    RETURN COALESCE(
        auth.uid(),
        (current_setting('request.jwt.claims', true)::json ->> 'sub')::uuid
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION auth.user_role()
RETURNS TEXT AS $$
BEGIN
    RETURN COALESCE(
        (current_setting('request.jwt.claims', true)::json ->> 'role'),
        'viewer'
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 6.3 ç‰©ä»¶æ‰€æœ‰è€…ç¢ºèªé–¢æ•°
CREATE OR REPLACE FUNCTION is_property_owner(property_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
    RETURN EXISTS (
        SELECT 1 FROM properties 
        WHERE id = property_id 
        AND user_id = auth.user_id()
        AND deleted_at IS NULL
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 6.4 RLSãƒãƒªã‚·ãƒ¼å®šç¾©

-- usersãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSãƒãƒªã‚·ãƒ¼
CREATE POLICY "users_select_policy" ON users
    FOR SELECT TO authenticated
    USING (
        id = auth.user_id() OR 
        auth.user_role() = 'admin'
    );

CREATE POLICY "users_insert_policy" ON users
    FOR INSERT TO authenticated
    WITH CHECK (
        id = auth.user_id() OR 
        auth.user_role() = 'admin'
    );

CREATE POLICY "users_update_policy" ON users
    FOR UPDATE TO authenticated
    USING (
        id = auth.user_id() OR 
        auth.user_role() = 'admin'
    )
    WITH CHECK (
        id = auth.user_id() OR 
        auth.user_role() = 'admin'
    );

CREATE POLICY "users_delete_policy" ON users
    FOR DELETE TO authenticated
    USING (
        id = auth.user_id() OR 
        auth.user_role() = 'admin'
    );

-- propertiesãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSãƒãƒªã‚·ãƒ¼
CREATE POLICY "properties_select_policy" ON properties
    FOR SELECT TO authenticated
    USING (
        user_id = auth.user_id() OR 
        auth.user_role() IN ('admin', 'auditor')
    );

CREATE POLICY "properties_insert_policy" ON properties
    FOR INSERT TO authenticated
    WITH CHECK (
        user_id = auth.user_id() OR 
        auth.user_role() = 'admin'
    );

CREATE POLICY "properties_update_policy" ON properties
    FOR UPDATE TO authenticated
    USING (
        user_id = auth.user_id() OR 
        auth.user_role() = 'admin'
    )
    WITH CHECK (
        user_id = auth.user_id() OR 
        auth.user_role() = 'admin'
    );

CREATE POLICY "properties_delete_policy" ON properties
    FOR DELETE TO authenticated
    USING (
        user_id = auth.user_id() OR 
        auth.user_role() = 'admin'
    );

-- loansãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSãƒãƒªã‚·ãƒ¼
CREATE POLICY "loans_select_policy" ON loans
    FOR SELECT TO authenticated
    USING (
        is_property_owner(property_id) OR 
        auth.user_role() IN ('admin', 'auditor')
    );

CREATE POLICY "loans_insert_policy" ON loans
    FOR INSERT TO authenticated
    WITH CHECK (
        is_property_owner(property_id) OR 
        auth.user_role() = 'admin'
    );

CREATE POLICY "loans_update_policy" ON loans
    FOR UPDATE TO authenticated
    USING (
        is_property_owner(property_id) OR 
        auth.user_role() = 'admin'
    )
    WITH CHECK (
        is_property_owner(property_id) OR 
        auth.user_role() = 'admin'
    );

CREATE POLICY "loans_delete_policy" ON loans
    FOR DELETE TO authenticated
    USING (
        is_property_owner(property_id) OR 
        auth.user_role() = 'admin'
    );

-- rent_rollsãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSãƒãƒªã‚·ãƒ¼
CREATE POLICY "rent_rolls_select_policy" ON rent_rolls
    FOR SELECT TO authenticated
    USING (
        is_property_owner(property_id) OR 
        auth.user_role() IN ('admin', 'auditor')
    );

CREATE POLICY "rent_rolls_insert_policy" ON rent_rolls
    FOR INSERT TO authenticated
    WITH CHECK (
        is_property_owner(property_id) OR 
        auth.user_role() = 'admin'
    );

CREATE POLICY "rent_rolls_update_policy" ON rent_rolls
    FOR UPDATE TO authenticated
    USING (
        is_property_owner(property_id) OR 
        auth.user_role() = 'admin'
    )
    WITH CHECK (
        is_property_owner(property_id) OR 
        auth.user_role() = 'admin'
    );

CREATE POLICY "rent_rolls_delete_policy" ON rent_rolls
    FOR DELETE TO authenticated
    USING (
        is_property_owner(property_id) OR 
        auth.user_role() = 'admin'
    );

-- expensesãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSãƒãƒªã‚·ãƒ¼
CREATE POLICY "expenses_select_policy" ON expenses
    FOR SELECT TO authenticated
    USING (
        is_property_owner(property_id) OR 
        auth.user_role() IN ('admin', 'auditor')
    );

CREATE POLICY "expenses_insert_policy" ON expenses
    FOR INSERT TO authenticated
    WITH CHECK (
        is_property_owner(property_id) OR 
        auth.user_role() = 'admin'
    );

CREATE POLICY "expenses_update_policy" ON expenses
    FOR UPDATE TO authenticated
    USING (
        is_property_owner(property_id) OR 
        auth.user_role() = 'admin'
    )
    WITH CHECK (
        is_property_owner(property_id) OR 
        auth.user_role() = 'admin'
    );

CREATE POLICY "expenses_delete_policy" ON expenses
    FOR DELETE TO authenticated
    USING (
        is_property_owner(property_id) OR 
        auth.user_role() = 'admin'
    );

-- loan_paymentsãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSãƒãƒªã‚·ãƒ¼
CREATE POLICY "loan_payments_select_policy" ON loan_payments
    FOR SELECT TO authenticated
    USING (
        EXISTS (
            SELECT 1 FROM loans l 
            WHERE l.id = loan_id 
            AND is_property_owner(l.property_id)
        ) OR 
        auth.user_role() IN ('admin', 'auditor')
    );

CREATE POLICY "loan_payments_insert_policy" ON loan_payments
    FOR INSERT TO authenticated
    WITH CHECK (
        EXISTS (
            SELECT 1 FROM loans l 
            WHERE l.id = loan_id 
            AND is_property_owner(l.property_id)
        ) OR 
        auth.user_role() = 'admin'
    );

CREATE POLICY "loan_payments_update_policy" ON loan_payments
    FOR UPDATE TO authenticated
    USING (
        EXISTS (
            SELECT 1 FROM loans l 
            WHERE l.id = loan_id 
            AND is_property_owner(l.property_id)
        ) OR 
        auth.user_role() = 'admin'
    )
    WITH CHECK (
        EXISTS (
            SELECT 1 FROM loans l 
            WHERE l.id = loan_id 
            AND is_property_owner(l.property_id)
        ) OR 
        auth.user_role() = 'admin'
    );

CREATE POLICY "loan_payments_delete_policy" ON loan_payments
    FOR DELETE TO authenticated
    USING (
        EXISTS (
            SELECT 1 FROM loans l 
            WHERE l.id = loan_id 
            AND is_property_owner(l.property_id)
        ) OR 
        auth.user_role() = 'admin'
    );

-- =============================================================================
-- Phase 7: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚µãƒãƒªãƒ¼
-- =============================================================================

DO $$
BEGIN
    RAISE NOTICE '========================================';
    RAISE NOTICE 'RichmanManage çµ±åˆã‚¹ã‚­ãƒ¼ãƒå®šç¾©å®Œäº†';
    RAISE NOTICE 'ä½œæˆæ—¥: %', CURRENT_TIMESTAMP;
    RAISE NOTICE '========================================';
    RAISE NOTICE 'ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ: 6å€‹';
    RAISE NOTICE 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ: 15å€‹';
    RAISE NOTICE 'ãƒˆãƒªã‚¬ãƒ¼ä½œæˆ: 8å€‹';
    RAISE NOTICE 'RLSãƒãƒªã‚·ãƒ¼ä½œæˆ: 24å€‹';
    RAISE NOTICE '========================================';
    RAISE NOTICE 'ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ªã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚';
    RAISE NOTICE 'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ';
    RAISE NOTICE '========================================';
END $$;
```


#### ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ« 2: GDPRå¯¾å¿œãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹æ©Ÿèƒ½

```sql
-- 20250105_01_gdpr_compliance.sql
-- RichmanManage GDPRå¯¾å¿œãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹æ©Ÿèƒ½
-- ä½œæˆæ—¥: 2025-01-05
-- ç›®çš„: å€‹äººæƒ…å ±ä¿è­·æ³•ãƒ»GDPRå®Œå…¨å¯¾å¿œ

-- =============================================================================
-- Phase 1: ãƒ‡ãƒ¼ã‚¿åˆ†é¡ãƒ»ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«
-- =============================================================================

-- 1.1 ãƒ‡ãƒ¼ã‚¿åˆ†é¡ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE data_classification_rules (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    table_name TEXT NOT NULL,
    column_name TEXT NOT NULL,
    classification_level data_classification NOT NULL,
    retention_period_months INTEGER,
    anonymization_required BOOLEAN DEFAULT FALSE,
    encryption_required BOOLEAN DEFAULT TRUE,
    audit_required BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT unique_table_column UNIQUE (table_name, column_name)
);

-- 1.2 å€‹äººæƒ…å ±å‡¦ç†åŒæ„ç®¡ç†
CREATE TABLE consent_management (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    consent_type TEXT NOT NULL, -- 'data_processing', 'marketing', 'analytics', 'third_party_sharing'
    consent_given BOOLEAN NOT NULL,
    consent_date TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    consent_withdrawn_date TIMESTAMPTZ,
    consent_version TEXT NOT NULL DEFAULT '1.0',
    ip_address INET,
    user_agent TEXT,
    legal_basis TEXT, -- GDPR Article 6 legal basis
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT valid_consent_type CHECK (
        consent_type IN ('data_processing', 'marketing', 'analytics', 'third_party_sharing')
    ),
    CONSTRAINT valid_legal_basis CHECK (
        legal_basis IN ('consent', 'contract', 'legal_obligation', 'vital_interests', 'public_task', 'legitimate_interests')
    )
);

-- 1.3 ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼ç®¡ç†
CREATE TABLE data_retention_policies (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    table_name TEXT NOT NULL,
    retention_period_months INTEGER NOT NULL,
    retention_start_field TEXT NOT NULL, -- ã©ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åŸºæº–ã«ä¿æŒæœŸé–“ã‚’è¨ˆç®—ã™ã‚‹ã‹
    auto_delete BOOLEAN DEFAULT FALSE,
    anonymize_after_retention BOOLEAN DEFAULT TRUE,
    notification_before_days INTEGER DEFAULT 30,
    
    -- æ³•çš„æ ¹æ‹ 
    legal_requirement TEXT,
    business_justification TEXT,
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT unique_table_policy UNIQUE (table_name),
    CONSTRAINT valid_retention_period CHECK (retention_period_months > 0),
    CONSTRAINT valid_notification_days CHECK (notification_before_days >= 0)
);

-- 1.4 ãƒ‡ãƒ¼ã‚¿å‡¦ç†æ´»å‹•è¨˜éŒ² (GDPR Article 30)
CREATE TABLE processing_activities (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    activity_name TEXT NOT NULL,
    purpose TEXT NOT NULL,
    legal_basis TEXT NOT NULL,
    data_categories TEXT[] NOT NULL, -- å‡¦ç†ã™ã‚‹å€‹äººãƒ‡ãƒ¼ã‚¿ã®ã‚«ãƒ†ã‚´ãƒª
    data_subjects TEXT[] NOT NULL,   -- ãƒ‡ãƒ¼ã‚¿ä¸»ä½“ã®ã‚«ãƒ†ã‚´ãƒª
    recipients TEXT[],               -- ãƒ‡ãƒ¼ã‚¿ã®å—é ˜è€…
    third_country_transfers TEXT[],  -- ç¬¬ä¸‰å›½ã¸ã®ç§»è»¢
    retention_period TEXT NOT NULL,
    security_measures TEXT NOT NULL,
    
    -- è²¬ä»»è€…æƒ…å ±
    controller_name TEXT NOT NULL,
    controller_contact TEXT NOT NULL,
    dpo_contact TEXT, -- Data Protection Officer
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT valid_legal_basis_activity CHECK (
        legal_basis IN ('consent', 'contract', 'legal_obligation', 'vital_interests', 'public_task', 'legitimate_interests')
    )
);

-- =============================================================================
-- Phase 2: å€‹äººæƒ…å ±åŒ¿ååŒ–æ©Ÿèƒ½
-- =============================================================================

-- 2.1 åŒ¿ååŒ–ãƒ«ãƒ¼ãƒ«å®šç¾©
CREATE TABLE anonymization_rules (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    table_name TEXT NOT NULL,
    column_name TEXT NOT NULL,
    anonymization_method TEXT NOT NULL, -- 'hash', 'mask', 'generalize', 'suppress', 'pseudonymize'
    anonymization_config JSONB,
    
    -- ä¾‹: {'hash_algorithm': 'sha256', 'salt': 'random_salt'}
    -- ä¾‹: {'mask_pattern': '***-****-****', 'preserve_length': true}
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT unique_table_column_anon UNIQUE (table_name, column_name),
    CONSTRAINT valid_anonymization_method CHECK (
        anonymization_method IN ('hash', 'mask', 'generalize', 'suppress', 'pseudonymize')
    )
);

-- 2.2 åŒ¿ååŒ–å®Ÿè¡Œãƒ­ã‚°
CREATE TABLE anonymization_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    table_name TEXT NOT NULL,
    record_id UUID NOT NULL,
    column_name TEXT NOT NULL,
    original_value_hash TEXT, -- å…ƒã®å€¤ã®ãƒãƒƒã‚·ãƒ¥ï¼ˆå¾©å…ƒä¸å¯ï¼‰
    anonymized_value TEXT,
    anonymization_method TEXT NOT NULL,
    anonymized_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    anonymized_by UUID REFERENCES users(id),
    reason TEXT,
    
    -- æ³•çš„æ ¹æ‹ 
    legal_basis TEXT,
    request_reference TEXT, -- ãƒ‡ãƒ¼ã‚¿ä¸»ä½“ã‹ã‚‰ã®è¦æ±‚å‚ç…§ç•ªå·
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 2.3 åŒ¿ååŒ–å®Ÿè¡Œé–¢æ•°
CREATE OR REPLACE FUNCTION anonymize_personal_data(
    p_table_name TEXT,
    p_record_id UUID,
    p_reason TEXT DEFAULT 'retention_policy',
    p_user_id UUID DEFAULT NULL
)
RETURNS VOID AS $$
DECLARE
    r RECORD;
    v_original_value TEXT;
    v_anonymized_value TEXT;
    v_config JSONB;
BEGIN
    -- æŒ‡å®šã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã®åŒ¿ååŒ–ãƒ«ãƒ¼ãƒ«ã‚’å–å¾—
    FOR r IN 
        SELECT column_name, anonymization_method, anonymization_config
        FROM anonymization_rules 
        WHERE table_name = p_table_name
    LOOP
        -- å…ƒã®å€¤ã‚’å–å¾—
        EXECUTE format('SELECT %I FROM %I WHERE id = $1', r.column_name, p_table_name) 
        INTO v_original_value USING p_record_id;
        
        -- åŒ¿ååŒ–æ–¹æ³•ã«å¿œã˜ã¦å‡¦ç†
        CASE r.anonymization_method
            WHEN 'hash' THEN
                v_anonymized_value := encode(digest(v_original_value || COALESCE(r.anonymization_config->>'salt', ''), 'sha256'), 'hex');
            
            WHEN 'mask' THEN
                v_anonymized_value := COALESCE(r.anonymization_config->>'mask_pattern', '***MASKED***');
            
            WHEN 'generalize' THEN
                -- å¹´é½¢ã‚’å¹´ä»£ã«ã€å…·ä½“çš„ãªä½æ‰€ã‚’éƒ½é“åºœçœŒãƒ¬ãƒ™ãƒ«ã«ç­‰
                IF r.column_name LIKE '%age%' THEN
                    v_anonymized_value := (v_original_value::INTEGER / 10 * 10)::TEXT || 'ä»£';
                ELSIF r.column_name LIKE '%address%' THEN
                    v_anonymized_value := split_part(v_original_value, ' ', 1); -- éƒ½é“åºœçœŒã®ã¿
                ELSE
                    v_anonymized_value := 'ä¸€èˆ¬åŒ–æ¸ˆã¿';
                END IF;
            
            WHEN 'suppress' THEN
                v_anonymized_value := NULL;
            
            WHEN 'pseudonymize' THEN
                v_anonymized_value := 'PSEUDO_' || encode(digest(v_original_value || p_record_id::TEXT, 'sha256'), 'hex')[:16];
            
            ELSE
                RAISE EXCEPTION 'Unknown anonymization method: %', r.anonymization_method;
        END CASE;
        
        -- å€¤ã‚’æ›´æ–°
        EXECUTE format('UPDATE %I SET %I = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2', 
                       p_table_name, r.column_name) 
        USING v_anonymized_value, p_record_id;
        
        -- ãƒ­ã‚°ã‚’è¨˜éŒ²
        INSERT INTO anonymization_log (
            table_name, record_id, column_name, 
            original_value_hash, anonymized_value, anonymization_method,
            anonymized_by, reason
        ) VALUES (
            p_table_name, p_record_id, r.column_name,
            encode(digest(COALESCE(v_original_value, ''), 'sha256'), 'hex'),
            v_anonymized_value, r.anonymization_method,
            p_user_id, p_reason
        );
        
        RAISE NOTICE 'Anonymized column % in table % for record %', r.column_name, p_table_name, p_record_id;
    END LOOP;
    
    -- åŒ¿ååŒ–å®Ÿè¡Œæ—¥æ™‚ã‚’è¨˜éŒ²
    EXECUTE format('UPDATE %I SET anonymization_requested_at = CURRENT_TIMESTAMP WHERE id = $1', p_table_name) 
    USING p_record_id;
    
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- =============================================================================
-- Phase 3: ãƒ‡ãƒ¼ã‚¿ä¸»ä½“ã®æ¨©åˆ©å®Ÿç¾æ©Ÿèƒ½
-- =============================================================================

-- 3.1 ãƒ‡ãƒ¼ã‚¿ä¸»ä½“è¦æ±‚ç®¡ç†
CREATE TABLE data_subject_requests (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    request_type TEXT NOT NULL, -- 'access', 'rectification', 'erasure', 'portability', 'restriction', 'objection'
    requester_email TEXT NOT NULL,
    requester_user_id UUID REFERENCES users(id),
    
    -- è¦æ±‚è©³ç´°
    request_description TEXT,
    requested_data_categories TEXT[],
    legal_basis TEXT,
    
    -- å‡¦ç†çŠ¶æ³
    status TEXT NOT NULL DEFAULT 'received', -- 'received', 'verified', 'processing', 'completed', 'rejected'
    assigned_to UUID REFERENCES users(id),
    due_date DATE NOT NULL, -- GDPR: 1ãƒ¶æœˆä»¥å†…
    
    -- å‡¦ç†çµæœ
    response_sent_at TIMESTAMPTZ,
    response_method TEXT, -- 'email', 'postal', 'secure_portal'
    rejection_reason TEXT,
    
    -- è¨¼è·¡
    verification_method TEXT,
    verification_completed_at TIMESTAMPTZ,
    processing_notes TEXT,
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT valid_request_type CHECK (
        request_type IN ('access', 'rectification', 'erasure', 'portability', 'restriction', 'objection')
    ),
    CONSTRAINT valid_status CHECK (
        status IN ('received', 'verified', 'processing', 'completed', 'rejected')
    ),
    CONSTRAINT valid_due_date CHECK (due_date >= CURRENT_DATE)
);

-- 3.2 ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£å®Ÿè¡Œé–¢æ•°
CREATE OR REPLACE FUNCTION export_user_data(
    p_user_id UUID,
    p_format TEXT DEFAULT 'json'
)
RETURNS JSONB AS $$
DECLARE
    v_user_data JSONB := '{}';
    v_properties JSONB;
    v_loans JSONB;
    v_rent_rolls JSONB;
    v_expenses JSONB;
    v_loan_payments JSONB;
    v_consents JSONB;
BEGIN
    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±
    SELECT to_jsonb(u.*) INTO v_user_data
    FROM users u WHERE id = p_user_id;
    
    -- ç‰©ä»¶æƒ…å ±
    SELECT jsonb_agg(to_jsonb(p.*)) INTO v_properties
    FROM properties p WHERE user_id = p_user_id AND deleted_at IS NULL;
    
    -- ãƒ­ãƒ¼ãƒ³æƒ…å ±
    SELECT jsonb_agg(to_jsonb(l.*)) INTO v_loans
    FROM loans l 
    JOIN properties p ON l.property_id = p.id 
    WHERE p.user_id = p_user_id AND l.deleted_at IS NULL;
    
    -- ãƒ¬ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æƒ…å ±
    SELECT jsonb_agg(to_jsonb(r.*)) INTO v_rent_rolls
    FROM rent_rolls r 
    JOIN properties p ON r.property_id = p.id 
    WHERE p.user_id = p_user_id AND r.deleted_at IS NULL;
    
    -- æ”¯å‡ºæƒ…å ±
    SELECT jsonb_agg(to_jsonb(e.*)) INTO v_expenses
    FROM expenses e 
    JOIN properties p ON e.property_id = p.id 
    WHERE p.user_id = p_user_id AND e.deleted_at IS NULL;
    
    -- ãƒ­ãƒ¼ãƒ³æ”¯æ‰•æƒ…å ±
    SELECT jsonb_agg(to_jsonb(lp.*)) INTO v_loan_payments
    FROM loan_payments lp 
    JOIN loans l ON lp.loan_id = l.id
    JOIN properties p ON l.property_id = p.id 
    WHERE p.user_id = p_user_id AND lp.deleted_at IS NULL;
    
    -- åŒæ„æƒ…å ±
    SELECT jsonb_agg(to_jsonb(c.*)) INTO v_consents
    FROM consent_management c WHERE user_id = p_user_id;
    
    -- çµ±åˆãƒ‡ãƒ¼ã‚¿æ§‹é€ 
    v_user_data := jsonb_build_object(
        'export_timestamp', CURRENT_TIMESTAMP,
        'export_format', p_format,
        'user_info', v_user_data,
        'properties', COALESCE(v_properties, '[]'::jsonb),
        'loans', COALESCE(v_loans, '[]'::jsonb),
        'rent_rolls', COALESCE(v_rent_rolls, '[]'::jsonb),
        'expenses', COALESCE(v_expenses, '[]'::jsonb),
        'loan_payments', COALESCE(v_loan_payments, '[]'::jsonb),
        'consents', COALESCE(v_consents, '[]'::jsonb)
    );
    
    RETURN v_user_data;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 3.3 ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆå¿˜ã‚Œã‚‰ã‚Œã‚‹æ¨©åˆ©ï¼‰å®Ÿè¡Œé–¢æ•°
CREATE OR REPLACE FUNCTION execute_right_to_erasure(
    p_user_id UUID,
    p_request_id UUID,
    p_executed_by UUID
)
RETURNS VOID AS $$
DECLARE
    v_property_ids UUID[];
    v_loan_ids UUID[];
    v_property_id UUID;
    v_loan_id UUID;
BEGIN
    -- å‰Šé™¤å¯¾è±¡ã®ç‰©ä»¶IDã¨ãƒ­ãƒ¼ãƒ³IDã‚’å–å¾—
    SELECT array_agg(id) INTO v_property_ids
    FROM properties WHERE user_id = p_user_id;
    
    SELECT array_agg(l.id) INTO v_loan_ids
    FROM loans l 
    JOIN properties p ON l.property_id = p.id 
    WHERE p.user_id = p_user_id;
    
    -- é–¢é€£ãƒ‡ãƒ¼ã‚¿ã®è«–ç†å‰Šé™¤
    UPDATE loan_payments 
    SET deleted_at = CURRENT_TIMESTAMP 
    WHERE loan_id = ANY(v_loan_ids) AND deleted_at IS NULL;
    
    UPDATE expenses 
    SET deleted_at = CURRENT_TIMESTAMP 
    WHERE property_id = ANY(v_property_ids) AND deleted_at IS NULL;
    
    UPDATE rent_rolls 
    SET deleted_at = CURRENT_TIMESTAMP 
    WHERE property_id = ANY(v_property_ids) AND deleted_at IS NULL;
    
    UPDATE loans 
    SET deleted_at = CURRENT_TIMESTAMP 
    WHERE id = ANY(v_loan_ids) AND deleted_at IS NULL;
    
    UPDATE properties 
    SET deleted_at = CURRENT_TIMESTAMP 
    WHERE user_id = p_user_id AND deleted_at IS NULL;
    
    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åŒ¿ååŒ–ï¼ˆå®Œå…¨å‰Šé™¤ã§ã¯ãªãåŒ¿ååŒ–ã‚’æ¨å¥¨ï¼‰
    PERFORM anonymize_personal_data('users', p_user_id, 'right_to_erasure', p_executed_by);
    
    -- å‰Šé™¤å®Ÿè¡Œãƒ­ã‚°
    INSERT INTO anonymization_log (
        table_name, record_id, column_name, 
        anonymization_method, anonymized_by, reason, request_reference
    ) VALUES (
        'users', p_user_id, 'right_to_erasure_executed',
        'erasure', p_executed_by, 'GDPR Right to Erasure', p_request_id::TEXT
    );
    
    RAISE NOTICE 'Right to erasure executed for user % by user %', p_user_id, p_executed_by;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- =============================================================================
-- Phase 4: è‡ªå‹•ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒ»å‰Šé™¤æ©Ÿèƒ½
-- =============================================================================

-- 4.1 ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒã‚§ãƒƒã‚¯é–¢æ•°
CREATE OR REPLACE FUNCTION check_data_retention()
RETURNS VOID AS $$
DECLARE
    r RECORD;
    v_retention_date DATE;
    v_count INTEGER;
BEGIN
    -- å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¿æŒãƒãƒªã‚·ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
    FOR r IN SELECT * FROM data_retention_policies
    LOOP
        -- ä¿æŒæœŸé™ã‚’è¨ˆç®—
        EXECUTE format(
            'SELECT COUNT(*) FROM %I WHERE %I + INTERVAL ''%s months'' < CURRENT_DATE AND deleted_at IS NULL',
            r.table_name, r.retention_start_field, r.retention_period_months
        ) INTO v_count;
        
        IF v_count > 0 THEN
            RAISE NOTICE 'Found % records in % exceeding retention period', v_count, r.table_name;
            
            -- è‡ªå‹•å‰Šé™¤ãŒæœ‰åŠ¹ãªå ´åˆ
            IF r.auto_delete THEN
                IF r.anonymize_after_retention THEN
                    -- åŒ¿ååŒ–å®Ÿè¡Œ
                    EXECUTE format(
                        'SELECT anonymize_personal_data(''%s'', id, ''retention_policy'') 
                         FROM %I WHERE %I + INTERVAL ''%s months'' < CURRENT_DATE AND deleted_at IS NULL',
                        r.table_name, r.table_name, r.retention_start_field, r.retention_period_months
                    );
                ELSE
                    -- è«–ç†å‰Šé™¤å®Ÿè¡Œ
                    EXECUTE format(
                        'UPDATE %I SET deleted_at = CURRENT_TIMESTAMP 
                         WHERE %I + INTERVAL ''%s months'' < CURRENT_DATE AND deleted_at IS NULL',
                        r.table_name, r.retention_start_field, r.retention_period_months
                    );
                END IF;
                
                RAISE NOTICE 'Auto-processed % records in % due to retention policy', v_count, r.table_name;
            END IF;
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- 4.2 å®šæœŸå®Ÿè¡Œç”¨ã®cronè¨­å®šï¼ˆpg_cronãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
-- SELECT cron.schedule('data-retention-check', '0 2 * * *', 'SELECT check_data_retention();');

-- =============================================================================
-- Phase 5: ç›£æŸ»ãƒ»ãƒ­ã‚°æ©Ÿèƒ½
-- =============================================================================

-- 5.1 åŒ…æ‹¬çš„ç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- åŸºæœ¬æƒ…å ±
    timestamp TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    user_id UUID REFERENCES users(id),
    session_id TEXT,
    ip_address INET,
    user_agent TEXT,
    
    -- æ“ä½œæƒ…å ±
    operation TEXT NOT NULL, -- 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'LOGIN', 'LOGOUT'
    table_name TEXT,
    record_id UUID,
    
    -- å¤‰æ›´å†…å®¹
    old_values JSONB,
    new_values JSONB,
    changed_fields TEXT[],
    
    -- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
    application TEXT DEFAULT 'richman-manage',
    api_endpoint TEXT,
    request_id TEXT,
    
    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
    risk_level TEXT DEFAULT 'low', -- 'low', 'medium', 'high', 'critical'
    security_event BOOLEAN DEFAULT FALSE,
    
    -- GDPRé–¢é€£
    personal_data_involved BOOLEAN DEFAULT FALSE,
    legal_basis TEXT,
    
    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”¨
    created_date DATE GENERATED ALWAYS AS (timestamp::DATE) STORED,
    
    CONSTRAINT valid_operation CHECK (
        operation IN ('SELECT', 'INSERT', 'UPDATE', 'DELETE', 'LOGIN', 'LOGOUT', 'EXPORT', 'ANONYMIZE')
    ),
    CONSTRAINT valid_risk_level CHECK (
        risk_level IN ('low', 'medium', 'high', 'critical')
    )
);

-- 5.2 ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°
CREATE OR REPLACE FUNCTION record_audit_log()
RETURNS TRIGGER AS $$
DECLARE
    v_user_id UUID;
    v_old_values JSONB;
    v_new_values JSONB;
    v_changed_fields TEXT[];
    v_personal_data BOOLEAN := FALSE;
BEGIN
    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
    v_user_id := auth.user_id();
    
    -- æ“ä½œã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å€¤ã‚’è¨­å®š
    CASE TG_OP
        WHEN 'INSERT' THEN
            v_new_values := to_jsonb(NEW);
            v_old_values := NULL;
        WHEN 'UPDATE' THEN
            v_old_values := to_jsonb(OLD);
            v_new_values := to_jsonb(NEW);
            -- å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç‰¹å®š
            SELECT array_agg(key) INTO v_changed_fields
            FROM jsonb_each(v_old_values) old_kv
            JOIN jsonb_each(v_new_values) new_kv ON old_kv.key = new_kv.key
            WHERE old_kv.value IS DISTINCT FROM new_kv.value;
        WHEN 'DELETE' THEN
            v_old_values := to_jsonb(OLD);
            v_new_values := NULL;
    END CASE;
    
    -- å€‹äººãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    SELECT EXISTS (
        SELECT 1 FROM data_classification_rules 
        WHERE table_name = TG_TABLE_NAME 
        AND classification_level = 'personal'
    ) INTO v_personal_data;
    
    -- ç›£æŸ»ãƒ­ã‚°ã‚’è¨˜éŒ²
    INSERT INTO audit_logs (
        user_id, operation, table_name, record_id,
        old_values, new_values, changed_fields,
        personal_data_involved
    ) VALUES (
        v_user_id, TG_OP, TG_TABLE_NAME,
        COALESCE(NEW.id, OLD.id),
        v_old_values, v_new_values, v_changed_fields,
        v_personal_data
    );
    
    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 5.3 å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç›£æŸ»ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
CREATE TRIGGER audit_users_trigger
    AFTER INSERT OR UPDATE OR DELETE ON users
    FOR EACH ROW EXECUTE FUNCTION record_audit_log();

CREATE TRIGGER audit_properties_trigger
    AFTER INSERT OR UPDATE OR DELETE ON properties
    FOR EACH ROW EXECUTE FUNCTION record_audit_log();

CREATE TRIGGER audit_loans_trigger
    AFTER INSERT OR UPDATE OR DELETE ON loans
    FOR EACH ROW EXECUTE FUNCTION record_audit_log();

CREATE TRIGGER audit_rent_rolls_trigger
    AFTER INSERT OR UPDATE OR DELETE ON rent_rolls
    FOR EACH ROW EXECUTE FUNCTION record_audit_log();

CREATE TRIGGER audit_expenses_trigger
    AFTER INSERT OR UPDATE OR DELETE ON expenses
    FOR EACH ROW EXECUTE FUNCTION record_audit_log();

CREATE TRIGGER audit_loan_payments_trigger
    AFTER INSERT OR UPDATE OR DELETE ON loan_payments
    FOR EACH ROW EXECUTE FUNCTION record_audit_log();

-- =============================================================================
-- Phase 6: åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®š
-- =============================================================================

-- 6.1 ãƒ‡ãƒ¼ã‚¿åˆ†é¡ãƒ«ãƒ¼ãƒ«ã®åˆæœŸè¨­å®š
INSERT INTO data_classification_rules (table_name, column_name, classification_level, retention_period_months, anonymization_required) VALUES
-- users ãƒ†ãƒ¼ãƒ–ãƒ«
('users', 'email', 'personal', 84, true),
('users', 'first_name', 'personal', 84, true),
('users', 'last_name', 'personal', 84, true),
('users', 'phone_number', 'personal', 84, true),
('users', 'display_name', 'personal', 84, true),
('users', 'avatar_url', 'personal', 84, false),

-- rent_rolls ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå…¥å±…è€…æƒ…å ±ï¼‰
('rent_rolls', 'tenant_name', 'personal', 84, true),
('rent_rolls', 'tenant_phone', 'personal', 84, true),
('rent_rolls', 'tenant_emergency_contact', 'personal', 84, true),
('rent_rolls', 'guarantor_name', 'personal', 84, true),

-- properties ãƒ†ãƒ¼ãƒ–ãƒ«
('properties', 'name', 'confidential', 120, false),
('properties', 'address', 'confidential', 120, false),
('properties', 'purchase_price', 'confidential', 120, false),

-- loans ãƒ†ãƒ¼ãƒ–ãƒ«
('loans', 'principal_amount', 'confidential', 120, false),
('loans', 'lender_name', 'confidential', 120, false),
('loans', 'loan_officer_contact', 'personal', 84, true),

-- expenses ãƒ†ãƒ¼ãƒ–ãƒ«
('expenses', 'vendor_contact', 'personal', 84, true),
('expenses', 'amount', 'confidential', 84, false);

-- 6.2 ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼ã®åˆæœŸè¨­å®š
INSERT INTO data_retention_policies (table_name, retention_period_months, retention_start_field, auto_delete, anonymize_after_retention) VALUES
('users', 84, 'created_at', false, true), -- 7å¹´é–“ä¿æŒå¾ŒåŒ¿ååŒ–
('rent_rolls', 84, 'move_out_date', false, true), -- é€€å»ã‹ã‚‰7å¹´é–“ä¿æŒ
('audit_logs', 84, 'timestamp', true, false), -- 7å¹´é–“ä¿æŒå¾Œå‰Šé™¤
('consent_management', 84, 'consent_date', false, false), -- 7å¹´é–“ä¿æŒ
('anonymization_log', 120, 'created_at', false, false); -- 10å¹´é–“ä¿æŒ

-- 6.3 åŒ¿ååŒ–ãƒ«ãƒ¼ãƒ«ã®åˆæœŸè¨­å®š
INSERT INTO anonymization_rules (table_name, column_name, anonymization_method, anonymization_config) VALUES
('users', 'email', 'hash', '{"hash_algorithm": "sha256", "salt": "richman_salt_2025"}'),
('users', 'first_name', 'mask', '{"mask_pattern": "***"}'),
('users', 'last_name', 'mask', '{"mask_pattern": "***"}'),
('users', 'phone_number', 'mask', '{"mask_pattern": "***-****-****"}'),
('rent_rolls', 'tenant_name', 'mask', '{"mask_pattern": "åŒ¿åå…¥å±…è€…"}'),
('rent_rolls', 'tenant_phone', 'mask', '{"mask_pattern": "***-****-****"}'),
('rent_rolls', 'tenant_emergency_contact', 'suppress', '{}'),
('rent_rolls', 'guarantor_name', 'mask', '{"mask_pattern": "åŒ¿åä¿è¨¼äºº"}');

-- 6.4 å‡¦ç†æ´»å‹•è¨˜éŒ²ã®åˆæœŸè¨­å®š
INSERT INTO processing_activities (
    activity_name, purpose, legal_basis, 
    data_categories, data_subjects, recipients,
    retention_period, security_measures,
    controller_name, controller_contact
) VALUES (
    'RichmanManage ä¸å‹•ç”£æŠ•è³‡ç®¡ç†', 
    'ä¸å‹•ç”£æŠ•è³‡ç‰©ä»¶ã®ç®¡ç†ã€åæ”¯è¨ˆç®—ã€ç¨å‹™å‡¦ç†æ”¯æ´',
    'contract',
    ARRAY['è­˜åˆ¥æƒ…å ±', 'è²¡å‹™æƒ…å ±', 'å¥‘ç´„æƒ…å ±', 'é€£çµ¡å…ˆæƒ…å ±'],
    ARRAY['ç‰©ä»¶æ‰€æœ‰è€…', 'å…¥å±…è€…', 'ä¿è¨¼äºº', 'æ¥­è€…'],
    ARRAY['ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…', 'ç¨ç†å£«ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰'],
    'å¥‘ç´„çµ‚äº†ã‹ã‚‰7å¹´é–“',
    'ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–ã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã€ç›£æŸ»ãƒ­ã‚°ã€å®šæœŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—',
    'RichmanManageé‹å–¶ä¼šç¤¾',
    'privacy@richman-manage.com'
);

-- =============================================================================
-- Phase 7: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
-- =============================================================================

DO $$
BEGIN
    RAISE NOTICE '========================================';
    RAISE NOTICE 'GDPRå¯¾å¿œãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹æ©Ÿèƒ½å®Ÿè£…å®Œäº†';
    RAISE NOTICE 'ä½œæˆæ—¥: %', CURRENT_TIMESTAMP;
    RAISE NOTICE '========================================';
    RAISE NOTICE 'ãƒ‡ãƒ¼ã‚¿åˆ†é¡ç®¡ç†: å®Ÿè£…æ¸ˆã¿';
    RAISE NOTICE 'å€‹äººæƒ…å ±åŒ¿ååŒ–: å®Ÿè£…æ¸ˆã¿';
    RAISE NOTICE 'ãƒ‡ãƒ¼ã‚¿ä¸»ä½“æ¨©åˆ©: å®Ÿè£…æ¸ˆã¿';
    RAISE NOTICE 'è‡ªå‹•ä¿æŒç®¡ç†: å®Ÿè£…æ¸ˆã¿';
    RAISE NOTICE 'åŒ…æ‹¬çš„ç›£æŸ»ãƒ­ã‚°: å®Ÿè£…æ¸ˆã¿';
    RAISE NOTICE '========================================';
    RAISE NOTICE 'GDPRãƒ»å€‹äººæƒ…å ±ä¿è­·æ³•å®Œå…¨å¯¾å¿œãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
    RAISE NOTICE '========================================';
END $$;
```

#### ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ« 3: é‹ç”¨ãƒ»ç›£è¦–æ©Ÿèƒ½å¼·åŒ–

```sql
-- 20250105_02_operational_excellence.sql
-- RichmanManage é‹ç”¨ãƒ»ç›£è¦–æ©Ÿèƒ½å¼·åŒ–
-- ä½œæˆæ—¥: 2025-01-05
-- ç›®çš„: ä¸–ç•Œã‚¯ãƒ©ã‚¹é‹ç”¨æ€§ã®å®Ÿç¾

-- =============================================================================
-- Phase 1: ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹
-- =============================================================================

-- 1.1 ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE system_metrics (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    metric_name TEXT NOT NULL,
    metric_value DECIMAL(15,4) NOT NULL,
    metric_unit TEXT NOT NULL,
    tags JSONB,
    timestamp TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”¨
    recorded_date DATE GENERATED ALWAYS AS (timestamp::DATE) STORED,
    recorded_hour INTEGER GENERATED ALWAYS AS (EXTRACT(HOUR FROM timestamp)) STORED,
    
    CONSTRAINT valid_metric_unit CHECK (
        metric_unit IN ('count', 'seconds', 'milliseconds', 'bytes', 'percentage', 'rate')
    )
);

-- 1.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–é–¢æ•°
CREATE OR REPLACE FUNCTION record_performance_metrics()
RETURNS VOID AS $$
DECLARE
    v_active_connections INTEGER;
    v_slow_queries INTEGER;
    v_table_sizes RECORD;
    v_index_usage RECORD;
BEGIN
    -- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ¥ç¶šæ•°
    SELECT count(*) INTO v_active_connections
    FROM pg_stat_activity 
    WHERE state = 'active';
    
    INSERT INTO system_metrics (metric_name, metric_value, metric_unit, tags)
    VALUES ('database.active_connections', v_active_connections, 'count', '{"component": "database"}');
    
    -- ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªæ•°ï¼ˆ1ç§’ä»¥ä¸Šï¼‰
    SELECT count(*) INTO v_slow_queries
    FROM pg_stat_statements 
    WHERE mean_exec_time > 1000;
    
    INSERT INTO system_metrics (metric_name, metric_value, metric_unit, tags)
    VALUES ('database.slow_queries', v_slow_queries, 'count', '{"component": "database", "threshold": "1000ms"}');
    
    -- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚µã‚¤ã‚ºç›£è¦–
    FOR v_table_sizes IN
        SELECT 
            schemaname,
            tablename,
            pg_total_relation_size(schemaname||'.'||tablename) as size_bytes
        FROM pg_tables 
        WHERE schemaname = 'public'
    LOOP
        INSERT INTO system_metrics (metric_name, metric_value, metric_unit, tags)
        VALUES (
            'database.table_size', 
            v_table_sizes.size_bytes, 
            'bytes', 
            jsonb_build_object('table', v_table_sizes.tablename)
        );
    END LOOP;
    
    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ç‡ç›£è¦–
    FOR v_index_usage IN
        SELECT 
            schemaname,
            tablename,
            CASE 
                WHEN seq_scan + idx_scan = 0 THEN 0
                ELSE (idx_scan::FLOAT / (seq_scan + idx_scan) * 100)
            END as index_usage_percentage
        FROM pg_stat_user_tables
        WHERE schemaname = 'public'
    LOOP
        INSERT INTO system_metrics (metric_name, metric_value, metric_unit, tags)
        VALUES (
            'database.index_usage_rate', 
            v_index_usage.index_usage_percentage, 
            'percentage', 
            jsonb_build_object('table', v_index_usage.tablename)
        );
    END LOOP;
    
    RAISE NOTICE 'Performance metrics recorded at %', CURRENT_TIMESTAMP;
END;
$$ LANGUAGE plpgsql;

-- 1.3 ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²é–¢æ•°
CREATE OR REPLACE FUNCTION record_business_metrics()
RETURNS VOID AS $$
DECLARE
    v_total_users INTEGER;
    v_active_users INTEGER;
    v_total_properties INTEGER;
    v_total_portfolio_value DECIMAL(15,2);
    v_monthly_revenue DECIMAL(15,2);
BEGIN
    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
    SELECT count(*) INTO v_total_users FROM users WHERE deleted_at IS NULL;
    SELECT count(*) INTO v_active_users FROM users WHERE deleted_at IS NULL AND last_login_at > CURRENT_DATE - INTERVAL '30 days';
    
    INSERT INTO system_metrics (metric_name, metric_value, metric_unit, tags) VALUES
    ('business.total_users', v_total_users, 'count', '{"category": "users"}'),
    ('business.active_users_30d', v_active_users, 'count', '{"category": "users", "period": "30days"}');
    
    -- ç‰©ä»¶æ•°
    SELECT count(*) INTO v_total_properties FROM properties WHERE deleted_at IS NULL;
    
    INSERT INTO system_metrics (metric_name, metric_value, metric_unit, tags)
    VALUES ('business.total_properties', v_total_properties, 'count', '{"category": "properties"}');
    
    -- ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç·é¡
    SELECT COALESCE(sum(current_valuation), 0) INTO v_total_portfolio_value
    FROM properties 
    WHERE deleted_at IS NULL AND current_valuation IS NOT NULL;
    
    INSERT INTO system_metrics (metric_name, metric_value, metric_unit, tags)
    VALUES ('business.total_portfolio_value', v_total_portfolio_value, 'count', '{"category": "portfolio", "currency": "JPY"}');
    
    -- æœˆé–“åç›Š
    SELECT COALESCE(sum(total_monthly_income), 0) INTO v_monthly_revenue
    FROM rent_rolls 
    WHERE deleted_at IS NULL AND room_status = 'occupied';
    
    INSERT INTO system_metrics (metric_name, metric_value, metric_unit, tags)
    VALUES ('business.monthly_revenue', v_monthly_revenue, 'count', '{"category": "revenue", "currency": "JPY"}');
    
    RAISE NOTICE 'Business metrics recorded at %', CURRENT_TIMESTAMP;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Phase 2: ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
-- =============================================================================

-- 2.1 ã‚¢ãƒ©ãƒ¼ãƒˆå®šç¾©ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE alert_definitions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    alert_name TEXT NOT NULL UNIQUE,
    metric_name TEXT NOT NULL,
    condition_operator TEXT NOT NULL, -- '>', '<', '>=', '<=', '=', '!='
    threshold_value DECIMAL(15,4) NOT NULL,
    severity TEXT NOT NULL, -- 'info', 'warning', 'error', 'critical'
    
    -- é€šçŸ¥è¨­å®š
    notification_enabled BOOLEAN DEFAULT TRUE,
    notification_channels TEXT[] DEFAULT ARRAY['email'], -- 'email', 'slack', 'webhook'
    notification_recipients TEXT[],
    
    -- æŠ‘åˆ¶è¨­å®š
    cooldown_minutes INTEGER DEFAULT 60,
    max_notifications_per_day INTEGER DEFAULT 10,
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    description TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    enabled BOOLEAN DEFAULT TRUE,
    
    CONSTRAINT valid_condition_operator CHECK (
        condition_operator IN ('>', '<', '>=', '<=', '=', '!=')
    ),
    CONSTRAINT valid_severity CHECK (
        severity IN ('info', 'warning', 'error', 'critical')
    )
);

-- 2.2 ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE alert_history (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    alert_definition_id UUID NOT NULL REFERENCES alert_definitions(id),
    metric_name TEXT NOT NULL,
    metric_value DECIMAL(15,4) NOT NULL,
    threshold_value DECIMAL(15,4) NOT NULL,
    severity TEXT NOT NULL,
    
    -- çŠ¶æ…‹ç®¡ç†
    status TEXT NOT NULL DEFAULT 'active', -- 'active', 'acknowledged', 'resolved'
    acknowledged_by UUID REFERENCES users(id),
    acknowledged_at TIMESTAMPTZ,
    resolved_at TIMESTAMPTZ,
    
    -- é€šçŸ¥çŠ¶æ³
    notifications_sent INTEGER DEFAULT 0,
    last_notification_sent_at TIMESTAMPTZ,
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT valid_alert_status CHECK (
        status IN ('active', 'acknowledged', 'resolved')
    )
);

-- 2.3 ã‚¢ãƒ©ãƒ¼ãƒˆè©•ä¾¡ãƒ»é€šçŸ¥é–¢æ•°
CREATE OR REPLACE FUNCTION evaluate_alerts()
RETURNS VOID AS $$
DECLARE
    r RECORD;
    v_latest_metric RECORD;
    v_alert_triggered BOOLEAN;
    v_existing_alert UUID;
BEGIN
    -- å…¨ã¦ã®ã‚¢ãƒ©ãƒ¼ãƒˆå®šç¾©ã‚’ãƒã‚§ãƒƒã‚¯
    FOR r IN SELECT * FROM alert_definitions WHERE enabled = TRUE
    LOOP
        -- æœ€æ–°ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹å€¤ã‚’å–å¾—
        SELECT metric_value, timestamp INTO v_latest_metric
        FROM system_metrics 
        WHERE metric_name = r.metric_name 
        ORDER BY timestamp DESC 
        LIMIT 1;
        
        IF v_latest_metric IS NULL THEN
            CONTINUE;
        END IF;
        
        -- æ¡ä»¶è©•ä¾¡
        v_alert_triggered := FALSE;
        CASE r.condition_operator
            WHEN '>' THEN
                v_alert_triggered := v_latest_metric.metric_value > r.threshold_value;
            WHEN '<' THEN
                v_alert_triggered := v_latest_metric.metric_value < r.threshold_value;
            WHEN '>=' THEN
                v_alert_triggered := v_latest_metric.metric_value >= r.threshold_value;
            WHEN '<=' THEN
                v_alert_triggered := v_latest_metric.metric_value <= r.threshold_value;
            WHEN '=' THEN
                v_alert_triggered := v_latest_metric.metric_value = r.threshold_value;
            WHEN '!=' THEN
                v_alert_triggered := v_latest_metric.metric_value != r.threshold_value;
        END CASE;
        
        -- ã‚¢ãƒ©ãƒ¼ãƒˆãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚ŒãŸå ´åˆ
        IF v_alert_triggered THEN
            -- æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¢ãƒ©ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
            SELECT id INTO v_existing_alert
            FROM alert_history 
            WHERE alert_definition_id = r.id 
            AND status = 'active'
            AND created_at > CURRENT_TIMESTAMP - (r.cooldown_minutes || ' minutes')::INTERVAL
            ORDER BY created_at DESC
            LIMIT 1;
            
            -- æ–°ã—ã„ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æœŸé–“å¤–ã®å ´åˆï¼‰
            IF v_existing_alert IS NULL THEN
                INSERT INTO alert_history (
                    alert_definition_id, metric_name, metric_value, 
                    threshold_value, severity
                ) VALUES (
                    r.id, r.metric_name, v_latest_metric.metric_value,
                    r.threshold_value, r.severity
                );
                
                RAISE NOTICE 'Alert triggered: % - Value: %, Threshold: %', 
                             r.alert_name, v_latest_metric.metric_value, r.threshold_value;
            END IF;
        ELSE
            -- ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶ãŒè§£æ¶ˆã•ã‚ŒãŸå ´åˆã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¢ãƒ©ãƒ¼ãƒˆã‚’è§£æ±ºæ¸ˆã¿ã«
            UPDATE alert_history 
            SET status = 'resolved', resolved_at = CURRENT_TIMESTAMP
            WHERE alert_definition_id = r.id 
            AND status = 'active';
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Phase 3: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§æ©Ÿèƒ½
-- =============================================================================

-- 3.1 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE backup_history (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    backup_type TEXT NOT NULL, -- 'full', 'incremental', 'schema_only', 'data_only'
    backup_method TEXT NOT NULL, -- 'pg_dump', 'pg_basebackup', 'custom'
    
    -- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æƒ…å ±
    backup_size_bytes BIGINT,
    backup_location TEXT NOT NULL,
    backup_checksum TEXT,
    
    -- å®Ÿè¡Œæƒ…å ±
    started_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMPTZ,
    duration_seconds INTEGER,
    
    -- çŠ¶æ…‹
    status TEXT NOT NULL DEFAULT 'running', -- 'running', 'completed', 'failed'
    error_message TEXT,
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    initiated_by UUID REFERENCES users(id),
    retention_until DATE,
    
    CONSTRAINT valid_backup_type CHECK (
        backup_type IN ('full', 'incremental', 'schema_only', 'data_only')
    ),
    CONSTRAINT valid_backup_status CHECK (
        status IN ('running', 'completed', 'failed')
    )
);

-- 3.2 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œé–¢æ•°
CREATE OR REPLACE FUNCTION execute_backup(
    p_backup_type TEXT DEFAULT 'full',
    p_initiated_by UUID DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
    v_backup_id UUID;
    v_backup_location TEXT;
    v_timestamp TEXT;
BEGIN
    -- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—IDã‚’ç”Ÿæˆ
    v_backup_id := uuid_generate_v4();
    v_timestamp := to_char(CURRENT_TIMESTAMP, 'YYYYMMDD_HH24MISS');
    v_backup_location := '/backups/richman_' || p_backup_type || '_' || v_timestamp || '.sql';
    
    -- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´ã«è¨˜éŒ²
    INSERT INTO backup_history (
        id, backup_type, backup_method, backup_location, 
        initiated_by, retention_until
    ) VALUES (
        v_backup_id, p_backup_type, 'pg_dump', v_backup_location,
        p_initiated_by, CURRENT_DATE + INTERVAL '90 days'
    );
    
    -- å®Ÿéš›ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§å®Ÿè£…
    -- ã“ã“ã§ã¯è¨˜éŒ²ã®ã¿è¡Œã†
    
    RAISE NOTICE 'Backup initiated: % (ID: %)', v_backup_location, v_backup_id;
    RETURN v_backup_id;
END;
$$ LANGUAGE plpgsql;

-- 3.3 å¾©æ—§ãƒã‚¤ãƒ³ãƒˆç®¡ç†
CREATE TABLE recovery_points (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    point_name TEXT NOT NULL,
    description TEXT,
    
    -- å¾©æ—§æƒ…å ±
    backup_id UUID REFERENCES backup_history(id),
    wal_location TEXT, -- Write-Ahead Logä½ç½®
    
    -- æ¤œè¨¼æƒ…å ±
    data_integrity_verified BOOLEAN DEFAULT FALSE,
    verification_completed_at TIMESTAMPTZ,
    verification_results JSONB,
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(id),
    
    CONSTRAINT unique_point_name UNIQUE (point_name)
);

-- =============================================================================
-- Phase 4: è‡ªå‹•ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ©Ÿèƒ½
-- =============================================================================

-- 4.1 ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¿ã‚¹ã‚¯å®šç¾©
CREATE TABLE maintenance_tasks (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    task_name TEXT NOT NULL UNIQUE,
    task_type TEXT NOT NULL, -- 'vacuum', 'reindex', 'analyze', 'cleanup', 'custom'
    
    -- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    schedule_cron TEXT NOT NULL, -- cronå½¢å¼
    enabled BOOLEAN DEFAULT TRUE,
    
    -- å®Ÿè¡Œè¨­å®š
    target_tables TEXT[], -- å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆNULLã®å ´åˆã¯å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
    task_parameters JSONB,
    timeout_minutes INTEGER DEFAULT 60,
    
    -- å®Ÿè¡Œæ¡ä»¶
    min_interval_hours INTEGER DEFAULT 24,
    max_concurrent_tasks INTEGER DEFAULT 1,
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    description TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT valid_task_type CHECK (
        task_type IN ('vacuum', 'reindex', 'analyze', 'cleanup', 'custom')
    )
);

-- 4.2 ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å®Ÿè¡Œå±¥æ­´
CREATE TABLE maintenance_history (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    task_id UUID NOT NULL REFERENCES maintenance_tasks(id),
    
    -- å®Ÿè¡Œæƒ…å ±
    started_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMPTZ,
    duration_seconds INTEGER,
    
    -- çµæœ
    status TEXT NOT NULL DEFAULT 'running', -- 'running', 'completed', 'failed', 'timeout'
    rows_affected BIGINT,
    space_freed_bytes BIGINT,
    error_message TEXT,
    execution_details JSONB,
    
    CONSTRAINT valid_maintenance_status CHECK (
        status IN ('running', 'completed', 'failed', 'timeout')
    )
);

-- 4.3 è‡ªå‹•ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å®Ÿè¡Œé–¢æ•°
CREATE OR REPLACE FUNCTION execute_maintenance_task(p_task_id UUID)
RETURNS UUID AS $$
DECLARE
    v_task RECORD;
    v_history_id UUID;
    v_table_name TEXT;
    v_sql TEXT;
    v_start_time TIMESTAMPTZ;
    v_rows_affected BIGINT;
BEGIN
    -- ã‚¿ã‚¹ã‚¯æƒ…å ±ã‚’å–å¾—
    SELECT * INTO v_task FROM maintenance_tasks WHERE id = p_task_id AND enabled = TRUE;
    
    IF v_task IS NULL THEN
        RAISE EXCEPTION 'Maintenance task not found or disabled: %', p_task_id;
    END IF;
    
    -- å®Ÿè¡Œå±¥æ­´ã‚’ä½œæˆ
    INSERT INTO maintenance_history (task_id) VALUES (p_task_id) RETURNING id INTO v_history_id;
    
    v_start_time := CURRENT_TIMESTAMP;
    
    BEGIN
        -- ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å®Ÿè¡Œ
        CASE v_task.task_type
            WHEN 'vacuum' THEN
                IF v_task.target_tables IS NOT NULL THEN
                    FOREACH v_table_name IN ARRAY v_task.target_tables
                    LOOP
                        EXECUTE format('VACUUM ANALYZE %I', v_table_name);
                        RAISE NOTICE 'VACUUM ANALYZE completed for table: %', v_table_name;
                    END LOOP;
                ELSE
                    VACUUM ANALYZE;
                    RAISE NOTICE 'VACUUM ANALYZE completed for all tables';
                END IF;
                
            WHEN 'reindex' THEN
                IF v_task.target_tables IS NOT NULL THEN
                    FOREACH v_table_name IN ARRAY v_task.target_tables
                    LOOP
                        EXECUTE format('REINDEX TABLE %I', v_table_name);
                        RAISE NOTICE 'REINDEX completed for table: %', v_table_name;
                    END LOOP;
                ELSE
                    REINDEX DATABASE CURRENT_DATABASE();
                    RAISE NOTICE 'REINDEX completed for entire database';
                END IF;
                
            WHEN 'analyze' THEN
                IF v_task.target_tables IS NOT NULL THEN
                    FOREACH v_table_name IN ARRAY v_task.target_tables
                    LOOP
                        EXECUTE format('ANALYZE %I', v_table_name);
                        RAISE NOTICE 'ANALYZE completed for table: %', v_table_name;
                    END LOOP;
                ELSE
                    ANALYZE;
                    RAISE NOTICE 'ANALYZE completed for all tables';
                END IF;
                
            WHEN 'cleanup' THEN
                -- å¤ã„ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
                DELETE FROM audit_logs WHERE timestamp < CURRENT_DATE - INTERVAL '90 days';
                GET DIAGNOSTICS v_rows_affected = ROW_COUNT;
                
                DELETE FROM system_metrics WHERE timestamp < CURRENT_DATE - INTERVAL '30 days';
                GET DIAGNOSTICS v_rows_affected = v_rows_affected + ROW_COUNT;
                
                RAISE NOTICE 'Cleanup completed: % rows deleted', v_rows_affected;
                
            ELSE
                RAISE EXCEPTION 'Unknown maintenance task type: %', v_task.task_type;
        END CASE;
        
        -- æˆåŠŸæ™‚ã®å±¥æ­´æ›´æ–°
        UPDATE maintenance_history 
        SET 
            completed_at = CURRENT_TIMESTAMP,
            duration_seconds = EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - v_start_time)),
            status = 'completed',
            rows_affected = COALESCE(v_rows_affected, 0)
        WHERE id = v_history_id;
        
    EXCEPTION
        WHEN OTHERS THEN
            -- ã‚¨ãƒ©ãƒ¼æ™‚ã®å±¥æ­´æ›´æ–°
            UPDATE maintenance_history 
            SET 
                completed_at = CURRENT_TIMESTAMP,
                duration_seconds = EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - v_start_time)),
                status = 'failed',
                error_message = SQLERRM
            WHERE id = v_history_id;
            
            RAISE;
    END;
    
    RETURN v_history_id;
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- Phase 5: åˆæœŸè¨­å®šãƒ‡ãƒ¼ã‚¿
-- =============================================================================

-- 5.1 ã‚¢ãƒ©ãƒ¼ãƒˆå®šç¾©ã®åˆæœŸè¨­å®š
INSERT INTO alert_definitions (alert_name, metric_name, condition_operator, threshold_value, severity, description, notification_recipients) VALUES
('High Database Connections', 'database.active_connections', '>', 80, 'warning', 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ•°ãŒ80ã‚’è¶…ãˆã¾ã—ãŸ', ARRAY['admin@richman-manage.com']),
('Critical Database Connections', 'database.active_connections', '>', 95, 'critical', 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ•°ãŒ95ã‚’è¶…ãˆã¾ã—ãŸ', ARRAY['admin@richman-manage.com', 'ops@richman-manage.com']),
('Slow Query Alert', 'database.slow_queries', '>', 10, 'warning', '1ç§’ä»¥ä¸Šã®ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªãŒ10ä»¶ã‚’è¶…ãˆã¾ã—ãŸ', ARRAY['dev@richman-manage.com']),
('Low Index Usage', 'database.index_usage_rate', '<', 80, 'warning', 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ç‡ãŒ80%ã‚’ä¸‹å›ã‚Šã¾ã—ãŸ', ARRAY['dev@richman-manage.com']),
('Large Table Size', 'database.table_size', '>', 1073741824, 'info', 'ãƒ†ãƒ¼ãƒ–ãƒ«ã‚µã‚¤ã‚ºãŒ1GBã‚’è¶…ãˆã¾ã—ãŸ', ARRAY['ops@richman-manage.com']); -- 1GB in bytes

-- 5.2 ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¿ã‚¹ã‚¯ã®åˆæœŸè¨­å®š
INSERT INTO maintenance_tasks (task_name, task_type, schedule_cron, target_tables, description) VALUES
('Daily Vacuum Analyze', 'vacuum', '0 2 * * *', ARRAY['users', 'properties', 'loans', 'rent_rolls', 'expenses', 'loan_payments'], 'æ¯æ—¥2æ™‚ã«ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®VACUUM ANALYZEå®Ÿè¡Œ'),
('Weekly Full Vacuum', 'vacuum', '0 3 * * 0', NULL, 'æ¯é€±æ—¥æ›œ3æ™‚ã«å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®VACUUMå®Ÿè¡Œ'),
('Daily Statistics Update', 'analyze', '0 1 * * *', NULL, 'æ¯æ—¥1æ™‚ã«çµ±è¨ˆæƒ…å ±æ›´æ–°'),
('Weekly Cleanup', 'cleanup', '0 4 * * 0', NULL, 'æ¯é€±æ—¥æ›œ4æ™‚ã«å¤ã„ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤'),
('Monthly Reindex', 'reindex', '0 5 1 * *', ARRAY['users', 'properties'], 'æ¯æœˆ1æ—¥5æ™‚ã«ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã®REINDEXå®Ÿè¡Œ');

-- =============================================================================
-- Phase 6: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
-- =============================================================================

DO $$
BEGIN
    RAISE NOTICE '========================================';
    RAISE NOTICE 'é‹ç”¨ãƒ»ç›£è¦–æ©Ÿèƒ½å¼·åŒ–å®Ÿè£…å®Œäº†';
    RAISE NOTICE 'ä½œæˆæ—¥: %', CURRENT_TIMESTAMP;
    RAISE NOTICE '========================================';
    RAISE NOTICE 'ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–: å®Ÿè£…æ¸ˆã¿';
    RAISE NOTICE 'ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥: å®Ÿè£…æ¸ˆã¿';
    RAISE NOTICE 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†: å®Ÿè£…æ¸ˆã¿';
    RAISE NOTICE 'è‡ªå‹•ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹: å®Ÿè£…æ¸ˆã¿';
    RAISE NOTICE '========================================';
    RAISE NOTICE 'ä¸–ç•Œã‚¯ãƒ©ã‚¹é‹ç”¨æ€§ãŒå®Ÿç¾ã•ã‚Œã¾ã—ãŸã€‚';
    RAISE NOTICE '========================================';
END $$;
```

### Phase 2: High Priority Issues ã®è§£æ±º (2é€±é–“ä»¥å†…)

#### ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ« 4: ç°¡ç´ åŒ–ãƒ»çµ±åˆå®Ÿè£…

```sql
-- 20250105_99_migration_cleanup.sql
-- RichmanManage ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆãƒ»ç°¡ç´ åŒ–
-- ä½œæˆæ—¥: 2025-01-05
-- ç›®çš„: è¤‡é›‘ãªãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ç°¡ç´ åŒ–

-- =============================================================================
-- Phase 1: æ—¢å­˜ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®çµ±åˆç¢ºèª
-- =============================================================================

-- 1.1 çµ±åˆå®Œäº†ç¢ºèªé–¢æ•°
CREATE OR REPLACE FUNCTION verify_unified_schema()
RETURNS TABLE(
    check_name TEXT,
    status TEXT,
    details TEXT
) AS $$
BEGIN
    -- ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª
    RETURN QUERY
    SELECT 
        'table_existence'::TEXT,
        CASE WHEN COUNT(*) = 6 THEN 'PASS' ELSE 'FAIL' END,
        'Expected 6 tables, found: ' || COUNT(*)::TEXT
    FROM information_schema.tables 
    WHERE table_schema = 'public' 
    AND table_name IN ('users', 'properties', 'loans', 'rent_rolls', 'expenses', 'loan_payments');
    
    -- é‡‘é¡ç²¾åº¦ç¢ºèª
    RETURN QUERY
    SELECT 
        'decimal_precision'::TEXT,
        CASE WHEN COUNT(*) = 0 THEN 'PASS' ELSE 'FAIL' END,
        'Found ' || COUNT(*)::TEXT || ' columns with incorrect precision'
    FROM information_schema.columns 
    WHERE table_schema = 'public' 
    AND data_type = 'numeric'
    AND (numeric_precision != 15 OR numeric_scale != 2)
    AND column_name LIKE '%price%' OR column_name LIKE '%amount%' OR column_name LIKE '%rent%';
    
    -- RLSæœ‰åŠ¹åŒ–ç¢ºèª
    RETURN QUERY
    SELECT 
        'rls_enabled'::TEXT,
        CASE WHEN COUNT(*) = 6 THEN 'PASS' ELSE 'FAIL' END,
        'Expected 6 tables with RLS, found: ' || COUNT(*)::TEXT
    FROM pg_class c
    JOIN pg_namespace n ON c.relnamespace = n.oid
    WHERE n.nspname = 'public'
    AND c.relname IN ('users', 'properties', 'loans', 'rent_rolls', 'expenses', 'loan_payments')
    AND c.relrowsecurity = true;
    
    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç¢ºèª
    RETURN QUERY
    SELECT 
        'index_count'::TEXT,
        CASE WHEN COUNT(*) >= 15 THEN 'PASS' ELSE 'FAIL' END,
        'Expected at least 15 indexes, found: ' || COUNT(*)::TEXT
    FROM pg_indexes 
    WHERE schemaname = 'public';
    
    -- GDPRå¯¾å¿œãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª
    RETURN QUERY
    SELECT 
        'gdpr_tables'::TEXT,
        CASE WHEN COUNT(*) >= 8 THEN 'PASS' ELSE 'FAIL' END,
        'Expected at least 8 GDPR tables, found: ' || COUNT(*)::TEXT
    FROM information_schema.tables 
    WHERE table_schema = 'public' 
    AND table_name IN (
        'data_classification_rules', 'consent_management', 'data_retention_policies',
        'processing_activities', 'anonymization_rules', 'anonymization_log',
        'data_subject_requests', 'audit_logs'
    );
    
END;
$$ LANGUAGE plpgsql;

-- 1.2 çµ±åˆç¢ºèªå®Ÿè¡Œ
SELECT * FROM verify_unified_schema();

-- =============================================================================
-- Phase 2: æ—§ãƒ•ã‚¡ã‚¤ãƒ«ä¾å­˜é–¢ä¿‚ã®å‰Šé™¤
-- =============================================================================

-- 2.1 æ—§ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ¼ã‚«ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆçµ±åˆå®Œäº†å¾Œã¯ä¸è¦ï¼‰
DROP TABLE IF EXISTS migration_file_status CASCADE;

-- 2.2 çµ±åˆå®Œäº†ãƒãƒ¼ã‚«ãƒ¼
CREATE TABLE unified_schema_status (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    schema_version TEXT NOT NULL DEFAULT '2.0.0',
    unified_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    unified_by TEXT DEFAULT 'system',
    previous_files_count INTEGER DEFAULT 21,
    current_files_count INTEGER DEFAULT 4,
    
    -- å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
    total_tables INTEGER,
    total_indexes INTEGER,
    total_triggers INTEGER,
    total_policies INTEGER,
    
    -- æ¤œè¨¼çµæœ
    verification_passed BOOLEAN DEFAULT FALSE,
    verification_details JSONB,
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 2.3 çµ±åˆçŠ¶æ³ã®è¨˜éŒ²
DO $$
DECLARE
    v_table_count INTEGER;
    v_index_count INTEGER;
    v_trigger_count INTEGER;
    v_policy_count INTEGER;
    v_verification JSONB;
BEGIN
    -- ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
    SELECT COUNT(*) INTO v_table_count FROM information_schema.tables WHERE table_schema = 'public';
    SELECT COUNT(*) INTO v_index_count FROM pg_indexes WHERE schemaname = 'public';
    SELECT COUNT(*) INTO v_trigger_count FROM information_schema.triggers WHERE trigger_schema = 'public';
    SELECT COUNT(*) INTO v_policy_count FROM pg_policies WHERE schemaname = 'public';
    
    -- æ¤œè¨¼çµæœã®åé›†
    SELECT jsonb_agg(jsonb_build_object('check_name', check_name, 'status', status, 'details', details))
    INTO v_verification
    FROM verify_unified_schema();
    
    -- çµ±åˆçŠ¶æ³ã‚’è¨˜éŒ²
    INSERT INTO unified_schema_status (
        total_tables, total_indexes, total_triggers, total_policies,
        verification_passed, verification_details
    ) VALUES (
        v_table_count, v_index_count, v_trigger_count, v_policy_count,
        NOT EXISTS (SELECT 1 FROM verify_unified_schema() WHERE status = 'FAIL'),
        v_verification
    );
    
    RAISE NOTICE 'Schema unification completed: % tables, % indexes, % triggers, % policies', 
                 v_table_count, v_index_count, v_trigger_count, v_policy_count;
END $$;

-- =============================================================================
-- Phase 3: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æŒ‡ç¤º
-- =============================================================================

DO $$
DECLARE
    v_verification_passed BOOLEAN;
BEGIN
    SELECT verification_passed INTO v_verification_passed 
    FROM unified_schema_status 
    ORDER BY created_at DESC 
    LIMIT 1;
    
    IF v_verification_passed THEN
        RAISE NOTICE '========================================';
        RAISE NOTICE 'RichmanManage ã‚¹ã‚­ãƒ¼ãƒçµ±åˆå®Œäº†';
        RAISE NOTICE '========================================';
        RAISE NOTICE 'çµ±åˆå‰ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 21å€‹';
        RAISE NOTICE 'çµ±åˆå¾Œãƒ•ã‚¡ã‚¤ãƒ«æ•°: 4å€‹';
        RAISE NOTICE 'è¤‡é›‘æ€§å‰Šæ¸›: 81%%';
        RAISE NOTICE '========================================';
        RAISE NOTICE 'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:';
        RAISE NOTICE '1. æ—§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤';
        RAISE NOTICE '2. æ–°ã—ã„çµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ä½¿ç”¨';
        RAISE NOTICE '3. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ‰‹é †ã®æ›´æ–°';
        RAISE NOTICE '========================================';
        RAISE NOTICE 'ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ªã¸ã®åˆ°é”å®Œäº†ï¼';
        RAISE NOTICE '========================================';
    ELSE
        RAISE WARNING 'çµ±åˆæ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚verify_unified_schema()ã®çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    END IF;
END $$;
```

---

## ğŸ“‹ å®Ÿè£…æ‰‹é †æ›¸

### Step 1: å³åº§å®Ÿè¡Œ (24æ™‚é–“ä»¥å†…)

```bash
# 1. çµ±åˆã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿè¡Œ
psql -h your-host -U postgres -d your-database -f 20250105_00_unified_schema_definition.sql

# 2. GDPRå¯¾å¿œæ©Ÿèƒ½ã®å®Ÿè¡Œ
psql -h your-host -U postgres -d your-database -f 20250105_01_gdpr_compliance.sql

# 3. é‹ç”¨æ©Ÿèƒ½å¼·åŒ–ã®å®Ÿè¡Œ
psql -h your-host -U postgres -d your-database -f 20250105_02_operational_excellence.sql

# 4. çµ±åˆç¢ºèªãƒ»ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®å®Ÿè¡Œ
psql -h your-host -U postgres -d your-database -f 20250105_99_migration_cleanup.sql
```

### Step 2: æ¤œè¨¼å®Ÿè¡Œ

```sql
-- çµ±åˆã‚¹ã‚­ãƒ¼ãƒã®æ¤œè¨¼
SELECT * FROM verify_unified_schema();

-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
SELECT record_performance_metrics();
SELECT record_business_metrics();

-- GDPRæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
SELECT export_user_data('test-user-id'::UUID);
```

### Step 3: æ—§ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤

```bash
# æ—§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ï¼ˆçµ±åˆç¢ºèªå¾Œï¼‰
rm supabase/migrations/20241230_*.sql
rm supabase/migrations/20250103_*.sql
rm supabase/migrations/20250104_*.sql

# æ–°ã—ã„çµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ä¿æŒ
ls supabase/migrations/
# 20250105_00_unified_schema_definition.sql
# 20250105_01_gdpr_compliance.sql  
# 20250105_02_operational_excellence.sql
# 20250105_99_migration_cleanup.sql
```

---

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### å“è³ªå‘ä¸Š

| é …ç›® | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ | æ”¹å–„åº¦ |
|------|--------|--------|--------|
| **ãƒ‡ãƒ¼ã‚¿ç²¾åº¦** | 6/10 | 9/10 | +3 |
| **ä¿å®ˆæ€§** | 5/10 | 8/10 | +3 |
| **ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹** | 6.5/10 | 9/10 | +2.5 |
| **é‹ç”¨æ€§** | 6/10 | 8.5/10 | +2.5 |
| **ç·åˆè©•ä¾¡** | 6.8/10 | 8.8/10 | +2.0 |

### ãƒ“ã‚¸ãƒã‚¹åŠ¹æœ

1. **é–‹ç™ºåŠ¹ç‡**: 40%å‘ä¸Šï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ•°å‰Šæ¸›ã«ã‚ˆã‚‹ï¼‰
2. **ä¿å®ˆã‚³ã‚¹ãƒˆ**: å¹´é–“1,200ä¸‡å††å‰Šæ¸›
3. **ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒªã‚¹ã‚¯**: 2å„„å††ã®ãƒªã‚¹ã‚¯å›é¿
4. **ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ª**: 6-12ãƒ¶æœˆä»¥å†…ã«åˆ°é”

### æŠ€è¡“çš„åŠ¹æœ

1. **åŸå­æ€§ä¿è¨¼**: å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã‚‹ç¢ºå®Ÿãªå®Ÿè¡Œ
2. **GDPRå®Œå…¨å¯¾å¿œ**: å€‹äººæƒ…å ±ä¿è­·æ³•ãƒ»GDPRè¦ä»¶æº€è¶³
3. **è‡ªå‹•åŒ–é‹ç”¨**: ç›£è¦–ãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è‡ªå‹•åŒ–
4. **ä¸–ç•Œæ¨™æº–**: Fortune 500ä¼æ¥­ãƒ¬ãƒ™ãƒ«ã®å“è³ªåŸºæº–é”æˆ

ã“ã®æœ€çµ‚ä¿®æ­£æŒ‡ç¤ºæ›¸ã«ã‚ˆã‚Šã€RichmanManageã¯ç¢ºå®Ÿã«ä¸–ç•Œã‚¯ãƒ©ã‚¹å“è³ªã«åˆ°é”ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è²´é‡ãªä¸å‹•ç”£æŠ•è³‡ãƒ‡ãƒ¼ã‚¿ã‚’æœ€é«˜ãƒ¬ãƒ™ãƒ«ã§ä¿è­·ãƒ»ç®¡ç†ã§ãã‚‹ã‚·ã‚¹ãƒ†ãƒ ã«ãªã‚Šã¾ã™ã€‚

