# CLAUDE.md - RichmanManage開発ガイドライン

## 🔨 最重要ルール - 新しいルールの追加プロセス

ユーザーから今回限りではなく常に対応が必要だと思われる指示を受けた場合：

1. 「これを標準のルールにしますか？」と質問する
2. YESの回答を得た場合、CLAUDE.mdに追加ルールとして記載する
3. 以降は標準ルールとして常に適用する

このプロセスにより、プロジェクトのルールを継続的に改善していきます。

## 基本原則

### 1. ドキュメント優先

- **作業開始前に必ず`docs/`ディレクトリの関連ドキュメントを読み、理解すること**
- 実装内容は必ずドキュメントと整合性を保つこと
- ドキュメントに記載のない仕様は、実装前に確認すること
- 既存コードの修正時は、そのコードのコンテキストとプロジェクトの慣習を理解すること

### 2. 品質基準

- テストカバレッジ80%以上を維持
- ESLintエラー0件、Warning最小限
- TypeScriptのany型使用禁止
- 適切なエラーハンドリングの実装

### 3. コミュニケーション

- 不明点は推測せず、必ず確認を求めること
- 作業の進捗は定期的に報告すること
- エラーや問題が発生した場合は、速やかに共有すること
- **同一のエラーが3回以上続く場合は、根本原因を分析し対策を検討すること**

### 4. 効率性

- **最小限の計算リソースで最大の効果を出すことを心がける**
- 冗長な処理や不要な繰り返しを避ける
- パフォーマンスを意識したコーディングを行う

### 5. 二重管理の回避

- **ドキュメントとコードの二重管理を避ける**
- API仕様は実装から自動生成（OpenAPI/Swagger）
- DBスキーマは実装から自動生成（マイグレーションファイル等）
- 実装を「Single Source of Truth」とする

### 6. 定期的リファクタリング

- **月1回以上のコードベース品質チェックを実施する**
- 型定義の重複・不整合を常に監視し、発見次第修正する
- ユーティリティ関数の重複を避け、共通化を促進する
- インポートパスの一貫性を保ち、依存関係を明確化する
- コンポーネントの責務分離と再利用性を継続的に改善する

## 📋 プロジェクト固有ルール

### コーディング規約

1. **言語**: TypeScript必須（any型は原則禁止）
2. **フレームワーク**: Next.js 15 (App Router)
3. **スタイリング**: Tailwind CSS + shadcn/ui
4. **状態管理**: React Context + useReducer（必要に応じてZustand）
5. **バリデーション**: Zod
6. **フォーマット**: Prettier設定に従う
7. **リント**: ESLint設定に従う（エラー0件必須）

### Git運用ルール

#### 作業前の確認

- **ステージングする前に必ず差分を確認し、意図しない変更が含まれていないかチェックする**
- コミット前に`git status`と`git diff --staged`で変更内容を確認する

#### コミット規約

1. **形式**: 日本語でのConventional Commits
   ```
   feat: 新機能追加
   fix: バグ修正
   chore: ビルド・設定変更
   docs: ドキュメント変更
   style: コードスタイル変更
   refactor: リファクタリング
   test: テスト追加・修正
   ```

2. **例**:
   ```
   feat: 固定資産税管理機能を追加
   fix: レントロール画面の金額計算エラーを修正
   ```

### ファイル・ディレクトリ構成

```
apps/web/
├── src/
│   ├── app/              # App Router pages
│   ├── components/       # React components
│   │   ├── ui/          # shadcn/ui components
│   │   └── features/    # Feature-specific components
│   ├── lib/             # Utility functions
│   ├── types/           # TypeScript type definitions
│   └── hooks/           # Custom React hooks
```

### データベース設計

1. **命名規則**: スネークケース（例: property_taxes）
2. **主キー**: UUID使用
3. **タイムスタンプ**: created_at, updated_at必須
4. **論理削除**: deleted_atで管理

### API設計

1. **RESTful設計**: 
   - GET /api/properties - 一覧取得
   - POST /api/properties - 新規作成
   - GET /api/properties/:id - 詳細取得
   - PUT /api/properties/:id - 更新
   - DELETE /api/properties/:id - 削除

2. **レスポンス形式**:
   ```json
   {
     "success": true,
     "data": {},
     "error": null
   }
   ```

### テスト方針

1. **必須テスト**:
   - ユニットテスト（Vitest）
   - E2Eテスト（Playwright）
   
2. **カバレッジ目標**: 80%以上

### 不動産投資用語

以下の用語を正しく理解して使用する：

- **物件**: 不動産投資の対象となる建物
- **レントロール**: 賃貸物件の部屋別収支一覧
- **キャッシュフロー（CF）**: 家賃収入から支出を引いた手取り
- **満室想定家賃**: 全室が埋まった場合の想定家賃
- **実質利回り**: 諸経費を考慮した実際の利回り
- **固定資産税**: 不動産に課される地方税（年4回納付）

### UI/UX原則

1. **40-50歳向けアクセシビリティ最優先**
   - 文字サイズ調整機能は全ページ必須
   - アイコンよりもテキストボタンを優先
   - ボタンサイズは最小36px以上
   - 十分なクリック領域とコントラスト比の確保

2. **レスポンシブデザイン**
   - 文字サイズ、行間、余白は相対的に調整
   - CSS変数を使用した統一的なスケーリング
   - 小さなUI要素（16px未満のアイコン等）は使用禁止

3. **モバイルファースト**: スマートフォンでの操作性を優先
4. **即座の反映**: 入力データは即座にUIに反映
5. **エラー表示**: ユーザーフレンドリーなメッセージ
6. **ローディング**: 処理中は必ずローディング表示

### セキュリティ・プライバシー

#### 機密情報の取り扱い

- **APIキー、パスワード、トークンなどの機密情報は絶対にコードに直接記載しない**
- 環境変数を使用し、`.env.local`に保存する
- 個人情報やセンシティブなデータはログに出力しない
- セキュリティに関わる変更は特に慎重にレビューする

#### セキュリティ実装

1. **認証**: Supabase Auth使用
2. **RLS**: Row Level Security必須
3. **入力検証**: フロント・バックエンド両方で実施
4. **機密情報**: 環境変数で管理

### パフォーマンス

1. **初回表示**: 3秒以内
2. **画面遷移**: 1秒以内
3. **API応答**: 500ms以内

## 🚀 開発フロー

1. **`docs/`を読んで理解する**
2. **Issue作成**: 作業開始前に必須
3. **ブランチ作成**: feature/[機能名] or fix/[バグ名]
4. **開発**: 上記ルールに従って実装
5. **テスト**: 自動テスト実行
6. **ドキュメントの更新**（必要に応じて）
7. **PR作成**: レビュー依頼
8. **マージ**: main/developへ

## 📝 ドキュメント更新

1. **変更時**: 仕様変更は必ずdocs/を更新
2. **新機能**: features/[機能名]/に詳細設計書作成
3. **API変更**: APIドキュメント更新必須

## 🔄 継続的改善

このドキュメントは生きたドキュメントです。新しいルールや改善点があれば、上記の最重要ルールに従って追加してください。

## 📊 リファクタリング標準プロセス

### 実施タイミング
- **定期実施**: 月1回以上
- **機能追加前**: 大きな機能追加の前
- **品質低下時**: ESLintエラー増加、型エラー頻発時
- **PR前**: 大きな変更をPRする前

### チェック項目

#### 1. 型定義の健全性
- [ ] `src/types/index.ts`の型定義が最新か
- [ ] 複数ファイルで同じ型が重複していないか
- [ ] 命名規則が統一されているか（snake_case vs camelCase）
- [ ] 不要な型定義が残っていないか

#### 2. ユーティリティ関数の重複
- [ ] 同じ処理をする関数が複数箇所にないか
- [ ] `src/lib/utils.ts`に共通化できる処理はないか
- [ ] フォーマット関数（日付、金額等）が統一されているか
- [ ] 計算ロジックが関数化されているか

#### 3. インポート・依存関係
- [ ] インポートパスが統一されているか
- [ ] 不要な依存関係がないか
- [ ] 存在しないモジュールを参照していないか
- [ ] 循環依存がないか

#### 4. コンポーネント設計
- [ ] 責務が適切に分離されているか
- [ ] 再利用可能な粒度になっているか
- [ ] props の型定義が適切か
- [ ] 不要な状態管理がないか

#### 5. 品質指標
- [ ] ESLintエラー0件
- [ ] TypeScriptコンパイルエラー0件
- [ ] テスト成功率100%
- [ ] ビルド成功

### 実施手順
1. **現状分析**: 上記チェック項目の確認
2. **問題特定**: 重複、不整合、非効率な箇所の洗い出し
3. **優先順位付け**: 影響度とリスクに基づく作業順序決定
4. **段階的修正**: 小さな単位での確実な修正
5. **テスト実行**: 各修正後の品質確認
6. **文書化**: 変更内容と理由の記録

## よくある質問

### Q: 新しい画面を追加する場合は？

A: 
1. `docs/requirements-and-screens.md`に画面定義を追加
2. `/apps/web/src/app/`に新しいルートを作成
3. 必要なコンポーネントを`/apps/web/src/components/`に実装

### Q: AI機能を実装する場合は？

A: 
1. 画像分析などのAI機能は、Supabase Edge Functionsを活用
2. クライアント側では進捗状況を表示し、UXを向上させる
3. エラーハンドリングを適切に実装し、フォールバック処理を用意

### Q: リファクタリングはどのくらいの頻度で行うべき？

A:
1. **定期実施**: 月1回以上の定期チェック
2. **機能追加前**: 大きな機能追加の前に実施
3. **品質低下時**: ESLintエラーや型エラーが頻発した際
4. 上記の「📊 リファクタリング標準プロセス」に従って実施する

